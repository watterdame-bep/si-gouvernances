{% extends 'base.html' %}
{% load static %}

{% block title %}Rédiger le Statut Technique - {{ ticket.numero_ticket }}{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="mb-6">
        <a href="{% url 'detail_ticket' projet.id ticket.id %}" class="text-blue-600 hover:text-blue-800 text-sm mb-2 inline-flex items-center">
            <i class="fas fa-arrow-left mr-2"></i> Retour au ticket
        </a>
        <h1 class="text-3xl font-bold text-gray-900 mt-2">
            <i class="fas fa-file-medical-alt mr-2 text-blue-600"></i>Rédiger le Statut Technique
        </h1>
        <p class="text-gray-600 mt-1">{{ ticket.numero_ticket }} - {{ ticket.titre }}</p>
    </div>

    <!-- Avertissement important -->
    <div class="bg-red-50 border-l-4 border-red-400 p-4 mb-6">
        <div class="flex">
            <div class="flex-shrink-0">
                <i class="fas fa-exclamation-circle text-red-400"></i>
            </div>
            <div class="ml-3">
                <h3 class="text-sm font-semibold text-red-800">Document obligatoire</h3>
                <p class="text-sm text-red-700 mt-1">
                    Le statut technique est un document obligatoire qui doit contenir une analyse complète du problème (Root Cause Analysis). Le ticket ne pourra être résolu qu'après validation de ce document par le chef de projet.
                </p>
            </div>
        </div>
    </div>

    <!-- Informations de l'intervention -->
    <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-6">
        <div class="flex">
            <div class="flex-shrink-0">
                <i class="fas fa-info-circle text-blue-400"></i>
            </div>
            <div class="ml-3 text-sm text-blue-700">
                <p><strong>Intervention:</strong> {{ intervention.description_actions|truncatewords:20 }}</p>
                <p><strong>Temps passé:</strong> {{ intervention.temps_passe }}h</p>
                <p><strong>Date:</strong> {{ intervention.date_debut|date:"d/m/Y H:i" }}</p>
            </div>
        </div>
    </div>

    <!-- Formulaire -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <form method="post" class="space-y-6">
            {% csrf_token %}

            <!-- Problème initial -->
            <div>
                <label for="probleme_initial" class="block text-sm font-medium text-gray-700 mb-2">
                    Problème initial <span class="text-red-500">*</span>
                </label>
                <textarea id="probleme_initial" name="probleme_initial" rows="4" required
                          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                          placeholder="Description du problème tel que rapporté par le client ou détecté...">{{ ticket.description_probleme }}</textarea>
                <p class="mt-1 text-sm text-gray-500">
                    Reprenez la description initiale du problème
                </p>
            </div>

            <!-- Cause réelle (Root Cause) -->
            <div>
                <label for="cause_reelle" class="block text-sm font-medium text-gray-700 mb-2">
                    Cause réelle (Root Cause Analysis) <span class="text-red-500">*</span>
                </label>
                <textarea id="cause_reelle" name="cause_reelle" rows="5" required
                          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                          placeholder="Analyse approfondie de la cause racine du problème...&#10;&#10;Ex:&#10;- Pourquoi le problème s'est-il produit?&#10;- Quelle est la cause technique exacte?&#10;- Y avait-il des conditions préalables?"></textarea>
                <p class="mt-1 text-sm text-gray-500">
                    <strong>Critique:</strong> Identifiez la cause racine, pas seulement les symptômes
                </p>
            </div>

            <!-- Solution apportée -->
            <div>
                <label for="solution_apportee" class="block text-sm font-medium text-gray-700 mb-2">
                    Solution apportée <span class="text-red-500">*</span>
                </label>
                <textarea id="solution_apportee" name="solution_apportee" rows="5" required
                          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                          placeholder="Description détaillée de la solution mise en place...&#10;&#10;Ex:&#10;- Modifications apportées au code&#10;- Configurations changées&#10;- Tests effectués pour valider la correction"></textarea>
                <p class="mt-1 text-sm text-gray-500">
                    Décrivez précisément comment le problème a été résolu
                </p>
            </div>

            <!-- Impact système -->
            <div>
                <label for="impact_systeme" class="block text-sm font-medium text-gray-700 mb-2">
                    Impact sur le système <span class="text-red-500">*</span>
                </label>
                <textarea id="impact_systeme" name="impact_systeme" rows="4" required
                          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                          placeholder="Quels composants du système sont affectés?&#10;&#10;Ex:&#10;- Modules impactés&#10;- Fonctionnalités concernées&#10;- Utilisateurs affectés"></textarea>
                <p class="mt-1 text-sm text-gray-500">
                    Identifiez tous les composants impactés par le problème et la solution
                </p>
            </div>

            <!-- Risques futurs -->
            <div>
                <label for="risques_futurs" class="block text-sm font-medium text-gray-700 mb-2">
                    Risques futurs
                </label>
                <textarea id="risques_futurs" name="risques_futurs" rows="3"
                          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                          placeholder="Y a-t-il des risques de récurrence?&#10;Des problèmes similaires pourraient-ils survenir ailleurs?"></textarea>
                <p class="mt-1 text-sm text-gray-500">
                    Identifiez les risques potentiels pour l'avenir
                </p>
            </div>

            <!-- Recommandations -->
            <div>
                <label for="recommandations" class="block text-sm font-medium text-gray-700 mb-2">
                    Recommandations
                </label>
                <textarea id="recommandations" name="recommandations" rows="4"
                          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                          placeholder="Actions préventives recommandées...&#10;&#10;Ex:&#10;- Améliorations à apporter&#10;- Tests supplémentaires à effectuer&#10;- Documentation à mettre à jour&#10;- Formation nécessaire"></textarea>
                <p class="mt-1 text-sm text-gray-500">
                    Proposez des actions pour éviter que le problème ne se reproduise
                </p>
            </div>

            <!-- Avertissement validation -->
            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fas fa-clock text-yellow-400"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-yellow-700">
                            <strong>Prochaine étape:</strong> Après avoir rédigé ce statut technique, il devra être validé par le chef de projet. Une fois validé, le ticket sera automatiquement marqué comme RÉSOLU.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Boutons -->
            <div class="flex items-center justify-between pt-4 border-t border-gray-200">
                <a href="{% url 'detail_ticket' projet.id ticket.id %}" 
                   class="text-gray-600 hover:text-gray-800">
                    Annuler
                </a>
                <button type="submit" 
                        class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium">
                    <i class="fas fa-file-medical-alt mr-2"></i>Soumettre le Statut Technique
                </button>
            </div>
        </form>
    </div>

    <!-- Guide Root Cause Analysis -->
    <div class="mt-6 bg-gray-50 rounded-lg p-4">
        <h3 class="text-sm font-semibold text-gray-900 mb-3">
            <i class="fas fa-lightbulb mr-2 text-yellow-500"></i>Guide: Root Cause Analysis (RCA)
        </h3>
        <div class="text-sm text-gray-600 space-y-2">
            <p><strong>Méthode des 5 Pourquoi:</strong></p>
            <ol class="list-decimal list-inside space-y-1 ml-2">
                <li>Pourquoi le problème s'est-il produit? → Réponse 1</li>
                <li>Pourquoi Réponse 1? → Réponse 2</li>
                <li>Pourquoi Réponse 2? → Réponse 3</li>
                <li>Pourquoi Réponse 3? → Réponse 4</li>
                <li>Pourquoi Réponse 4? → <strong>Cause racine</strong></li>
            </ol>
            <p class="mt-3"><strong>Éléments à inclure:</strong></p>
            <ul class="list-disc list-inside space-y-1 ml-2">
                <li>Contexte technique précis</li>
                <li>Conditions qui ont déclenché le problème</li>
                <li>Pourquoi les contrôles existants n'ont pas détecté le problème</li>
                <li>Impact sur les utilisateurs et le système</li>
            </ul>
        </div>
    </div>
</div>
{% endblock %}
