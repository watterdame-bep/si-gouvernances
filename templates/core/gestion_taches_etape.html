{% extends 'base.html' %}

{% block title %}Tâches - {{ etape.type_etape.get_nom_display }} - {{ projet.nom }} - SI-Gouvernance JCM{% endblock %}
{% block page_title %}Gestion des Tâches - {{ etape.type_etape.get_nom_display }}{% endblock %}

{% block content %}
<div class="bg-gray-50 min-h-screen p-4">
    <div class="max-w-7xl mx-auto space-y-4">
        
        <!-- Header professionnel -->
        <div class="bg-white rounded-lg p-4 shadow-sm border border-gray-200">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 rounded-lg flex items-center justify-center shadow-sm
                        {% if etape.statut == 'TERMINEE' %}bg-green-100 border border-green-200
                        {% elif etape.statut == 'EN_COURS' %}bg-blue-100 border border-blue-200
                        {% else %}bg-gray-100 border border-gray-200{% endif %}">
                        <i class="fas fa-tasks text-lg
                            {% if etape.statut == 'TERMINEE' %}text-green-600
                            {% elif etape.statut == 'EN_COURS' %}text-blue-600
                            {% else %}text-gray-600{% endif %}"></i>
                    </div>
                    <div>
                        <h1 class="text-lg font-semibold text-gray-900">Tâches de l'Étape</h1>
                        <p class="text-sm text-gray-600">
                            <i class="fas fa-layer-group mr-1"></i>
                            {{ etape.type_etape.get_nom_display }} • {{ projet.nom }}
                        </p>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    {% if can_create %}
                    <a href="{% url 'creer_tache_etape' projet.id etape.id %}" 
                       class="inline-flex items-center px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-md text-sm transition-colors">
                        <i class="fas fa-plus mr-2"></i>Nouvelle Tâche
                    </a>
                    {% endif %}
                    <a href="{% url 'detail_etape' projet.id etape.id %}" 
                       class="inline-flex items-center px-3 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-md font-medium text-sm transition-colors">
                        <i class="fas fa-arrow-left mr-2"></i>Retour
                    </a>
                </div>
            </div>
        </div>

        <!-- Message informatif pour étapes terminées -->
        {% if etape_terminee and can_create %}
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
            <div class="flex items-start space-x-3">
                <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center flex-shrink-0">
                    <i class="fas fa-info-circle text-blue-600"></i>
                </div>
                <div class="flex-1">
                    <h3 class="text-sm font-medium text-blue-800 mb-1">
                        Étape terminée - Ajout de tâches possible
                    </h3>
                    <p class="text-sm text-blue-700">
                        Cette étape est terminée, mais vous pouvez encore ajouter des tâches si nécessaire (avec justification). 
                        Cela peut être utile si vous avez oublié quelque chose ou si de nouveaux besoins sont identifiés.
                    </p>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Statistiques de l'étape -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="bg-white rounded-lg p-4 shadow-sm border border-gray-200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Statut Étape</p>
                        <p class="text-lg font-bold
                            {% if etape.statut == 'TERMINEE' %}text-green-600
                            {% elif etape.statut == 'EN_COURS' %}text-blue-600
                            {% else %}text-gray-600{% endif %}">
                            {% if etape.statut == 'TERMINEE' %}Terminée
                            {% elif etape.statut == 'EN_COURS' %}En Cours
                            {% else %}À Venir{% endif %}
                        </p>
                    </div>
                    <div class="w-10 h-10 rounded-lg flex items-center justify-center
                        {% if etape.statut == 'TERMINEE' %}bg-green-100
                        {% elif etape.statut == 'EN_COURS' %}bg-blue-100
                        {% else %}bg-gray-100{% endif %}">
                        <i class="fas 
                            {% if etape.statut == 'TERMINEE' %}fa-check text-green-600
                            {% elif etape.statut == 'EN_COURS' %}fa-play text-blue-600
                            {% else %}fa-clock text-gray-600{% endif %}"></i>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg p-4 shadow-sm border border-gray-200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Total Tâches</p>
                        <p class="text-2xl font-bold text-gray-900">{{ taches.count }}</p>
                    </div>
                    <div class="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-list text-gray-600"></i>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg p-4 shadow-sm border border-gray-200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Terminées</p>
                        <p class="text-2xl font-bold text-green-600">{{ taches_terminees.count }}</p>
                    </div>
                    <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-check text-green-600"></i>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg p-4 shadow-sm border border-gray-200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Progression</p>
                        <p class="text-2xl font-bold text-purple-600">
                            {% if taches.count > 0 %}
                                {% widthratio taches_terminees.count taches.count 100 %}%
                            {% else %}
                                0%
                            {% endif %}
                        </p>
                    </div>
                    <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-chart-line text-purple-600"></i>
                    </div>
                </div>
            </div>
        </div>
        <!-- Liste des tâches - Tableau moderne -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
            <div class="p-4 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <i class="fas fa-table text-gray-600 mr-2"></i>
                        <h2 class="text-lg font-semibold text-gray-900">Tâches de l'Étape</h2>
                    </div>
                    <span class="text-sm text-gray-500">{{ taches.count }} tâche{{ taches.count|pluralize }}</span>
                </div>
            </div>
            
            {% if taches %}
            <!-- Tableau moderne -->
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50 border-b border-gray-200">
                        <tr>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">
                                <i class="fas fa-tasks mr-1"></i>Tâche
                            </th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">
                                <i class="fas fa-info-circle mr-1"></i>Statut
                            </th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">
                                <i class="fas fa-user mr-1"></i>Responsable
                            </th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">
                                <i class="fas fa-chart-line mr-1"></i>Progression
                            </th>
                            <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase">
                                <i class="fas fa-cog mr-1"></i>Actions
                            </th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100" data-tache-id="{{ tache.id }}" data-responsable-id="{% if tache.responsable %}{{ tache.responsable.id }}{% endif %}">
                        {% for tache in taches %}
                        <tr class="hover:bg-blue-50 transition-colors">
                            <!-- Nom de la tâche -->
                            <td class="px-3 py-2">
                                <div class="flex items-start">
                                    <div class="flex-1">
                                        <div class="text-sm font-medium text-gray-900 mb-1">
                                            {{ tache.nom|truncatewords:8 }}
                                        </div>
                                        {% if tache.ajoutee_apres_cloture %}
                                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-yellow-100 text-yellow-800">
                                            <i class="fas fa-star mr-1"></i>Spéciale
                                        </span>
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                            
                            <!-- Statut -->
                            <td class="px-3 py-2 text-center">
                                {% if tache.statut == 'A_FAIRE' %}
                                    <span class="text-gray-500" title="À faire"><i class="fas fa-play-circle text-lg"></i></span>
                                {% elif tache.statut == 'EN_COURS' %}
                                    <span class="text-orange-500" title="En cours"><i class="fas fa-play-circle text-lg"></i></span>
                                {% elif tache.statut == 'EN_PAUSE' %}
                                    <span class="text-yellow-500" title="En pause"><i class="fas fa-pause-circle text-lg"></i></span>
                                {% elif tache.statut == 'TERMINEE' %}
                                    <span class="text-green-500" title="Terminée"><i class="fas fa-check-circle text-lg"></i></span>
                                {% endif %}
                            </td>
                            
                            <!-- Responsable -->
                            <td class="px-3 py-2">
                                <div class="flex items-center text-sm">
                                    {% if tache.responsable %}
                                    <div class="w-7 h-7 bg-blue-600 rounded-full flex items-center justify-center mr-2">
                                        <span class="text-white text-xs font-bold">{{ tache.responsable.first_name.0 }}</span>
                                    </div>
                                    <span class="text-gray-700">{{ tache.responsable.get_full_name|truncatewords:2 }}</span>
                                    {% else %}
                                    <i class="fas fa-user-slash text-orange-400 mr-2"></i>
                                    <span class="text-orange-600 text-sm">Non assignée</span>
                                    {% endif %}
                                </div>
                            </td>
                            
                            <!-- Progression -->
                            <td class="px-3 py-2">
                                <div class="flex items-center">
                                    <div class="w-full bg-gray-200 rounded-full h-2 mr-2" style="max-width: 80px;">
                                        <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" 
                                             style="width: {{ tache.pourcentage_completion }}%"></div>
                                    </div>
                                    <span class="text-xs font-medium text-gray-600 whitespace-nowrap">{{ tache.pourcentage_completion }}%</span>
                                </div>
                            </td>
                            
                            <!-- Actions -->
                            <td class="px-3 py-2">
                                {% if can_create %}
                                <div class="flex items-center justify-center space-x-2">
                                    <!-- Bouton Voir -->
                                    <button onclick="voirDetailsTache('{{ tache.id }}', '{{ tache.nom|escapejs }}', '{{ tache.description|escapejs }}', '{{ tache.responsable.get_full_name|default:"Non assignée"|escapejs }}', '{{ tache.date_creation|date:"d/m/Y" }}', '{{ tache.pourcentage_completion }}', '{{ etape.statut }}')"
                                            class="text-blue-600 hover:text-blue-800 p-1.5 rounded transition-colors"
                                            title="Voir détails">
                                        <i class="fas fa-eye text-sm"></i>
                                    </button>
                                    
                                    {% if tache.statut != 'TERMINEE' %}
                                    <!-- Bouton Assigner/Transférer -->
                                    {% if not tache.responsable %}
                                    <button onclick="assignerTache('{{ tache.id }}')"
                                            class="text-blue-600 hover:text-blue-800 p-1.5 rounded transition-colors"
                                            title="Assigner">
                                        <i class="fas fa-user-plus text-sm"></i>
                                    </button>
                                    {% else %}
                                    <button onclick="transfererTache('{{ tache.id }}')"
                                            class="text-indigo-600 hover:text-indigo-800 p-1.5 rounded transition-colors"
                                            title="Transférer">
                                        <i class="fas fa-exchange-alt text-sm"></i>
                                    </button>
                                    {% endif %}
                                    
                                    <!-- Bouton Modifier -->
                                    <a href="{% url 'modifier_tache_etape' projet.id etape.id tache.id %}"
                                       class="text-gray-600 hover:text-gray-800 p-1.5 rounded transition-colors"
                                       title="Modifier">
                                        <i class="fas fa-edit text-sm"></i>
                                    </a>
                                    
                                    <!-- Bouton Gérer les Tests (uniquement pour étape TEST) -->
                                    {% if etape.type_etape.nom == 'TESTS' %}
                                    <a href="{% url 'gestion_cas_tests_tache' projet.id etape.id tache.id %}"
                                       class="text-purple-600 hover:text-purple-800 p-1.5 rounded transition-colors"
                                       title="Gérer les cas de test">
                                        <i class="fas fa-vial text-sm"></i>
                                    </a>
                                    {% endif %}
                                    
                                    <!-- Bouton Gérer les Déploiements (uniquement pour étape DEPLOIEMENT) -->
                                    {% if etape.type_etape.nom == 'DEPLOIEMENT' %}
                                    <a href="{% url 'gestion_deploiements_tache' projet.id etape.id tache.id %}"
                                       class="text-blue-600 hover:text-blue-800 p-1.5 rounded transition-colors"
                                       title="Gérer les déploiements">
                                        <i class="fas fa-rocket text-sm"></i>
                                    </a>
                                    {% endif %}
                                    
                                    <!-- Bouton Terminer -->
                                    <button onclick="terminerTache('{{ tache.id }}')"
                                            class="text-green-600 hover:text-green-800 p-1.5 rounded transition-colors"
                                            title="Terminer">
                                        <i class="fas fa-check text-sm"></i>
                                    </button>
                                    {% else %}
                                    <!-- Tâche terminée - Afficher bouton Cas de Test pour consultation -->
                                    {% if etape.type_etape.nom == 'TESTS' %}
                                    <a href="{% url 'gestion_cas_tests_tache' projet.id etape.id tache.id %}"
                                       class="text-purple-600 hover:text-purple-800 p-1.5 rounded transition-colors"
                                       title="Consulter les cas de test">
                                        <i class="fas fa-vial text-sm"></i>
                                    </a>
                                    {% endif %}
                                    {% endif %}
                                </div>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <!-- État vide -->
            <div class="p-8 text-center">
                <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-tasks text-gray-400 text-2xl"></i>
                </div>
                <h3 class="text-lg font-medium text-gray-500 mb-2">Aucune tâche créée</h3>
                <p class="text-sm text-gray-400 mb-4">Créez votre première tâche pour organiser le travail sur cette étape</p>
                {% if can_create %}
                <a href="{% url 'creer_tache_etape' projet.id etape.id %}" 
                   class="inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-md text-sm transition-colors">
                    <i class="fas fa-plus mr-2"></i>Créer une Tâche
                </a>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal Assigner/Transférer Tâche -->
<div id="assignModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
        <div class="bg-blue-600 rounded-t-lg px-4 py-3 text-white">
            <h3 class="text-lg font-semibold" id="assignTitle">
                <i class="fas fa-user-plus mr-2"></i>Assigner la tâche
            </h3>
        </div>
        
        <form id="assignForm" class="p-4 space-y-4">
            {% csrf_token %}
            <input type="hidden" id="tacheId" name="tache_id">
            
            <div>
                <label for="responsable_id" class="block text-sm font-medium text-gray-700 mb-1">
                    <i class="fas fa-user text-blue-600 mr-1"></i>
                    Responsable
                </label>
                <select id="responsable_id" name="responsable_id" required 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="">Sélectionner un responsable...</option>
                    {% for membre in equipe %}
                    <option value="{{ membre.id }}">{{ membre.get_full_name }}</option>
                    {% endfor %}
                </select>
            </div>
        </form>
        
        <div class="bg-gray-50 rounded-b-lg px-4 py-3 flex items-center justify-end space-x-3">
            <button onclick="fermerModalAssign()" 
                    class="px-3 py-1.5 text-gray-600 hover:text-gray-800 font-medium text-sm transition-colors">
                Annuler
            </button>
            <button onclick="confirmerAssignation()" 
                    class="px-4 py-1.5 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-md text-sm transition-colors">
                <i class="fas fa-check mr-1"></i>Confirmer
            </button>
        </div>
    </div>
</div>

<!-- Modal Gérer Cas de Test -->
<div id="casTestModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
        <div class="bg-purple-600 rounded-t-lg px-4 py-3 text-white">
            <div class="flex items-center justify-between">
                <h3 class="text-lg font-semibold" id="casTestTitle">
                    <i class="fas fa-vial mr-2"></i>Gérer les Cas de Test
                </h3>
                <button onclick="fermerModalCasTest()" class="text-white hover:text-gray-200 p-1 rounded transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
        </div>
        
        <div class="p-4 max-h-[70vh] overflow-y-auto">
            <div id="casTestContent">
                <!-- Le contenu sera chargé dynamiquement -->
                <div class="text-center py-8">
                    <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-spinner fa-spin text-purple-600 text-xl"></i>
                    </div>
                    <p class="text-gray-600">Chargement des cas de test...</p>
                </div>
            </div>
        </div>
        
        <div class="bg-gray-50 rounded-b-lg px-4 py-3 flex items-center justify-between">
            <button onclick="creerNouveauCasTest()" 
                    class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white font-medium rounded-md text-sm transition-colors">
                <i class="fas fa-plus mr-1"></i>Nouveau Cas de Test
            </button>
            <button onclick="fermerModalCasTest()" 
                    class="px-3 py-1.5 text-gray-600 hover:text-gray-800 font-medium text-sm transition-colors">
                Fermer
            </button>
        </div>
    </div>
</div>

<!-- Modal Créer Cas de Test -->
<div id="creerCasTestModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-hidden">
        <div class="bg-green-600 rounded-t-lg px-4 py-3 text-white">
            <h3 class="text-lg font-semibold">
                <i class="fas fa-plus mr-2"></i>Créer un Cas de Test
            </h3>
        </div>
        
        <form id="creerCasTestForm" class="p-4 space-y-4 max-h-[70vh] overflow-y-auto">
            {% csrf_token %}
            <input type="hidden" id="tacheTestId" name="tache_test_id">
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="casTestNom" class="block text-sm font-medium text-gray-700 mb-1">
                        <i class="fas fa-tag text-green-600 mr-1"></i>
                        Nom du cas de test *
                    </label>
                    <input type="text" id="casTestNom" name="nom" required 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 focus:border-green-500"
                           placeholder="Ex: Connexion avec email valide">
                </div>
                
                <div>
                    <label for="casTestPriorite" class="block text-sm font-medium text-gray-700 mb-1">
                        <i class="fas fa-exclamation-triangle text-orange-600 mr-1"></i>
                        Priorité
                    </label>
                    <select id="casTestPriorite" name="priorite" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 focus:border-green-500">
                        <option value="MOYENNE">Moyenne</option>
                        <option value="BASSE">Basse</option>
                        <option value="HAUTE">Haute</option>
                        <option value="CRITIQUE">Critique</option>
                    </select>
                </div>
            </div>
            
            <div>
                <label for="casTestDescription" class="block text-sm font-medium text-gray-700 mb-1">
                    <i class="fas fa-align-left text-blue-600 mr-1"></i>
                    Description *
                </label>
                <textarea id="casTestDescription" name="description" required rows="3"
                          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 focus:border-green-500"
                          placeholder="Description détaillée du cas de test"></textarea>
            </div>
            
            <div>
                <label for="casTestDonneesEntree" class="block text-sm font-medium text-gray-700 mb-1">
                    <i class="fas fa-database text-indigo-600 mr-1"></i>
                    Données d'entrée
                </label>
                <textarea id="casTestDonneesEntree" name="donnees_entree" rows="2"
                          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 focus:border-green-500"
                          placeholder="Données nécessaires pour ce test"></textarea>
            </div>
            
            <div>
                <label for="casTestPreconditions" class="block text-sm font-medium text-gray-700 mb-1">
                    <i class="fas fa-check-square text-teal-600 mr-1"></i>
                    Préconditions
                </label>
                <textarea id="casTestPreconditions" name="preconditions" rows="2"
                          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 focus:border-green-500"
                          placeholder="Conditions préalables à remplir"></textarea>
            </div>
            
            <div>
                <label for="casTestEtapesExecution" class="block text-sm font-medium text-gray-700 mb-1">
                    <i class="fas fa-list-ol text-purple-600 mr-1"></i>
                    Étapes d'exécution *
                </label>
                <textarea id="casTestEtapesExecution" name="etapes_execution" required rows="4"
                          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 focus:border-green-500"
                          placeholder="1. Étape 1&#10;2. Étape 2&#10;3. Étape 3"></textarea>
            </div>
            
            <div>
                <label for="casTestResultatsAttendus" class="block text-sm font-medium text-gray-700 mb-1">
                    <i class="fas fa-bullseye text-red-600 mr-1"></i>
                    Résultats attendus *
                </label>
                <textarea id="casTestResultatsAttendus" name="resultats_attendus" required rows="3"
                          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 focus:border-green-500"
                          placeholder="Résultats attendus pour ce cas spécifique"></textarea>
            </div>
        </form>
        
        <div class="bg-gray-50 rounded-b-lg px-4 py-3 flex items-center justify-end space-x-3">
            <button onclick="fermerModalCreerCasTest()" 
                    class="px-3 py-1.5 text-gray-600 hover:text-gray-800 font-medium text-sm transition-colors">
                Annuler
            </button>
            <button onclick="confirmerCreerCasTest()" 
                    class="px-4 py-1.5 bg-green-600 hover:bg-green-700 text-white font-medium rounded-md text-sm transition-colors">
                <i class="fas fa-check mr-1"></i>Créer
            </button>
        </div>
    </div>
</div>
<div id="completeModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
        <div class="bg-green-600 rounded-t-lg px-4 py-3 text-white">
            <h3 class="text-lg font-semibold">
                <i class="fas fa-check-circle mr-2"></i>Terminer la tâche
            </h3>
        </div>
        
        <div class="p-4 text-center">
            <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-check text-green-600 text-xl"></i>
            </div>
            <p class="text-gray-600 mb-4">Confirmer que cette tâche est terminée ?</p>
            
            <form id="completeForm">
                {% csrf_token %}
                <input type="hidden" id="completeTacheId" name="tache_id">
            </form>
        </div>
        
        <div class="bg-gray-50 rounded-b-lg px-4 py-3 flex items-center justify-end space-x-3">
            <button onclick="fermerModalComplete()" 
                    class="px-3 py-1.5 text-gray-600 hover:text-gray-800 font-medium text-sm transition-colors">
                Annuler
            </button>
            <button onclick="confirmerTerminer()" 
                    class="px-4 py-1.5 bg-green-600 hover:bg-green-700 text-white font-medium rounded-md text-sm transition-colors">
                <i class="fas fa-check mr-1"></i>Terminer
            </button>
        </div>
    </div>
</div>

<!-- Modal Détails Tâche -->
<div id="detailsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[80vh] overflow-hidden">
        <div class="bg-blue-600 rounded-t-lg px-4 py-3 text-white">
            <div class="flex items-center justify-between">
                <h3 class="text-lg font-semibold">
                    <i class="fas fa-info-circle mr-2"></i>Détails de la Tâche
                </h3>
                <button onclick="fermerModalDetails()" class="text-white hover:text-gray-200 p-1 rounded transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
        </div>
        
        <div class="p-6 overflow-y-auto max-h-[60vh]">
            <div id="detailsContent">
                <!-- Le contenu sera chargé dynamiquement -->
            </div>
        </div>
        
        <div class="bg-gray-50 rounded-b-lg px-4 py-3 flex items-center justify-end">
            <button onclick="fermerModalDetails()" 
                    class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white font-medium rounded-md text-sm transition-colors">
                <i class="fas fa-times mr-1"></i>Fermer
            </button>
        </div>
    </div>
</div>

<script>
let isTransferMode = false;
let currentTacheId = null;
let currentTacheTestId = null;

function assignerTache(tacheId) {
    isTransferMode = false;
    document.getElementById('assignTitle').innerHTML = '<i class="fas fa-user-plus mr-2"></i>Assigner la tâche';
    document.getElementById('tacheId').value = tacheId;
    
    // Réinitialiser le select
    const select = document.getElementById('responsable_id');
    select.selectedIndex = 0;
    const options = select.querySelectorAll('option');
    options.forEach(option => option.style.display = 'block');
    
    document.getElementById('assignModal').classList.remove('hidden');
}

function transfererTache(tacheId) {
    isTransferMode = true;
    document.getElementById('assignTitle').innerHTML = '<i class="fas fa-exchange-alt mr-2"></i>Transférer la tâche';
    document.getElementById('tacheId').value = tacheId;
    
    // Masquer le responsable actuel
    const tacheElement = document.querySelector(`[data-tache-id="${tacheId}"]`);
    const responsableActuelId = tacheElement ? tacheElement.getAttribute('data-responsable-id') : null;
    
    const select = document.getElementById('responsable_id');
    select.selectedIndex = 0;
    const options = select.querySelectorAll('option');
    
    let optionsDisponibles = 0;
    options.forEach(option => {
        if (option.value === '' || option.value === responsableActuelId) {
            option.style.display = 'none';
        } else {
            option.style.display = 'block';
            optionsDisponibles++;
        }
    });
    
    if (optionsDisponibles === 0) {
        afficherMessage('error', 'Aucun autre membre disponible pour le transfert.');
        return;
    }
    
    document.getElementById('assignModal').classList.remove('hidden');
}

function fermerModalAssign() {
    document.getElementById('assignModal').classList.add('hidden');
}

function terminerTache(tacheId) {
    document.getElementById('completeTacheId').value = tacheId;
    document.getElementById('completeModal').classList.remove('hidden');
}

function fermerModalComplete() {
    document.getElementById('completeModal').classList.add('hidden');
}

// Nouvelles fonctions pour la gestion des cas de test
function gererCasTests(tacheId, nomTache) {
    currentTacheId = tacheId;
    document.getElementById('casTestTitle').innerHTML = `<i class="fas fa-vial mr-2"></i>Cas de Test - ${nomTache}`;
    document.getElementById('casTestModal').classList.remove('hidden');
    
    // Charger les cas de test existants
    chargerCasTests(tacheId);
}

function chargerCasTests(tacheId) {
    // D'abord, trouver la TacheTest correspondante
    fetch(`/api/tache-etape/${tacheId}/tache-test/`, {
        method: 'GET',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.tache_test_id) {
            currentTacheTestId = data.tache_test_id;
            // Maintenant charger les cas de test
            return fetch(`/api/tache-test/${data.tache_test_id}/cas-tests/`, {
                method: 'GET',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                }
            });
        } else {
            throw new Error('Aucune tâche de test trouvée pour cette tâche d\'étape');
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            afficherCasTests(data.cas_tests);
        } else {
            throw new Error(data.error || 'Erreur lors du chargement des cas de test');
        }
    })
    .catch(error => {
        document.getElementById('casTestContent').innerHTML = `
            <div class="text-center py-8">
                <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                </div>
                <p class="text-red-600 mb-2">Erreur lors du chargement</p>
                <p class="text-gray-600 text-sm">${error.message}</p>
                <button onclick="chargerCasTests('${tacheId}')" class="mt-3 px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700">
                    Réessayer
                </button>
            </div>
        `;
    });
}

function afficherCasTests(casTests) {
    if (!casTests || casTests.length === 0) {
        document.getElementById('casTestContent').innerHTML = `
            <div class="text-center py-8">
                <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-vial text-gray-400 text-xl"></i>
                </div>
                <h3 class="text-base font-medium text-gray-500 mb-2">Aucun cas de test</h3>
                <p class="text-sm text-gray-400 mb-4">Créez votre premier cas de test pour cette tâche</p>
                <button onclick="creerNouveauCasTest()" class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700">
                    <i class="fas fa-plus mr-1"></i>Créer un Cas de Test
                </button>
            </div>
        `;
        return;
    }
    
    let html = '<div class="space-y-3">';
    casTests.forEach(cas => {
        const statutColor = {
            'EN_ATTENTE': 'bg-gray-100 text-gray-800',
            'EN_COURS': 'bg-blue-100 text-blue-800',
            'PASSE': 'bg-green-100 text-green-800',
            'ECHEC': 'bg-red-100 text-red-800',
            'BLOQUE': 'bg-yellow-100 text-yellow-800'
        };
        
        const prioriteColor = {
            'BASSE': 'bg-gray-100 text-gray-600',
            'MOYENNE': 'bg-blue-100 text-blue-700',
            'HAUTE': 'bg-orange-100 text-orange-700',
            'CRITIQUE': 'bg-red-100 text-red-700'
        };
        
        html += `
            <div class="p-4 bg-gray-50 rounded-lg border border-gray-200 hover:bg-gray-100 transition-colors">
                <div class="flex items-start justify-between mb-3">
                    <div class="flex-1">
                        <h4 class="text-sm font-semibold text-gray-900 mb-1">${cas.numero_cas} - ${cas.nom}</h4>
                        <p class="text-xs text-gray-600 mb-2">${cas.description}</p>
                    </div>
                    <div class="flex space-x-2 ml-4">
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${prioriteColor[cas.priorite] || 'bg-gray-100 text-gray-600'}">
                            ${cas.priorite_display}
                        </span>
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${statutColor[cas.statut] || 'bg-gray-100 text-gray-600'}">
                            ${cas.statut_display}
                        </span>
                    </div>
                </div>
                
                <div class="flex items-center justify-between text-xs text-gray-500">
                    <div class="flex items-center space-x-3">
                        <span><i class="fas fa-calendar-alt mr-1"></i>${cas.date_creation}</span>
                        ${cas.executeur ? `<span><i class="fas fa-user mr-1"></i>${cas.executeur}</span>` : ''}
                    </div>
                    <div class="flex space-x-1">
                        ${cas.statut === 'EN_ATTENTE' || cas.statut === 'ECHEC' ? `
                            <button onclick="executerCasTest('${cas.id}', 'PASSE')" 
                                    class="px-2 py-1 bg-green-600 text-white rounded text-xs hover:bg-green-700" title="Marquer comme réussi">
                                <i class="fas fa-check"></i>
                            </button>
                            <button onclick="executerCasTest('${cas.id}', 'ECHEC')" 
                                    class="px-2 py-1 bg-red-600 text-white rounded text-xs hover:bg-red-700" title="Marquer comme échoué">
                                <i class="fas fa-times"></i>
                            </button>
                        ` : ''}
                        <button onclick="voirDetailsCasTest('${cas.id}')" 
                                class="px-2 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700" title="Voir détails">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    html += '</div>';
    
    document.getElementById('casTestContent').innerHTML = html;
}

function creerNouveauCasTest() {
    if (!currentTacheTestId) {
        afficherMessage('error', 'Erreur: Aucune tâche de test sélectionnée');
        return;
    }
    
    document.getElementById('tacheTestId').value = currentTacheTestId;
    document.getElementById('creerCasTestForm').reset();
    document.getElementById('creerCasTestModal').classList.remove('hidden');
}

function fermerModalCasTest() {
    document.getElementById('casTestModal').classList.add('hidden');
    currentTacheId = null;
    currentTacheTestId = null;
}

function fermerModalCreerCasTest() {
    document.getElementById('creerCasTestModal').classList.add('hidden');
}

function confirmerCreerCasTest() {
    const form = document.getElementById('creerCasTestForm');
    const formData = new FormData(form);
    
    const submitBtn = document.querySelector('#creerCasTestModal button[onclick="confirmerCreerCasTest()"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Création...';
    
    fetch(`{% url 'creer_cas_test' projet.id etape.id '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', currentTacheTestId), {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            fermerModalCreerCasTest();
            afficherMessage('success', data.message);
            // Recharger les cas de test
            chargerCasTests(currentTacheId);
        } else {
            afficherMessage('error', data.error);
        }
    })
    .catch(error => {
        afficherMessage('error', 'Erreur de communication avec le serveur');
    })
    .finally(() => {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    });
}

function executerCasTest(casTestId, statut) {
    const resultats = prompt(`Résultats obtenus pour ce cas de test (${statut === 'PASSE' ? 'succès' : 'échec'}):`);
    if (resultats === null) return; // Annulé
    
    fetch(`{% url 'executer_cas_test' projet.id etape.id '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', casTestId), {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `statut=${statut}&resultats_obtenus=${encodeURIComponent(resultats)}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            afficherMessage('success', data.message);
            // Recharger les cas de test
            chargerCasTests(currentTacheId);
        } else {
            afficherMessage('error', data.error);
        }
    })
    .catch(error => {
        afficherMessage('error', 'Erreur de communication avec le serveur');
    });
}

function voirDetailsCasTest(casTestId) {
    fetch(`{% url 'details_cas_test' projet.id etape.id '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', casTestId), {
        method: 'GET',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const cas = data.cas;
            alert(`Détails du cas de test ${cas.numero_cas}:\n\n` +
                  `Nom: ${cas.nom}\n` +
                  `Description: ${cas.description}\n` +
                  `Priorité: ${cas.priorite_display}\n` +
                  `Statut: ${cas.statut_display}\n` +
                  `Étapes d'exécution:\n${cas.etapes_execution}\n` +
                  `Résultats attendus:\n${cas.resultats_attendus}` +
                  (cas.resultats_obtenus ? `\n\nRésultats obtenus:\n${cas.resultats_obtenus}` : ''));
        } else {
            afficherMessage('error', data.error);
        }
    })
    .catch(error => {
        afficherMessage('error', 'Erreur de communication avec le serveur');
    });
}

function assignerTache(tacheId) {
    isTransferMode = false;
    document.getElementById('assignTitle').innerHTML = '<i class="fas fa-user-plus mr-2"></i>Assigner la tâche';
    document.getElementById('tacheId').value = tacheId;
    
    // Réinitialiser le select
    const select = document.getElementById('responsable_id');
    select.selectedIndex = 0;
    const options = select.querySelectorAll('option');
    options.forEach(option => option.style.display = 'block');
    
    document.getElementById('assignModal').classList.remove('hidden');
}

function transfererTache(tacheId) {
    isTransferMode = true;
    document.getElementById('assignTitle').innerHTML = '<i class="fas fa-exchange-alt mr-2"></i>Transférer la tâche';
    document.getElementById('tacheId').value = tacheId;
    
    // Masquer le responsable actuel
    const tacheElement = document.querySelector(`[data-tache-id="${tacheId}"]`);
    const responsableActuelId = tacheElement ? tacheElement.getAttribute('data-responsable-id') : null;
    
    const select = document.getElementById('responsable_id');
    select.selectedIndex = 0;
    const options = select.querySelectorAll('option');
    
    let optionsDisponibles = 0;
    options.forEach(option => {
        if (option.value === '' || option.value === responsableActuelId) {
            option.style.display = 'none';
        } else {
            option.style.display = 'block';
            optionsDisponibles++;
        }
    });
    
    if (optionsDisponibles === 0) {
        afficherMessage('error', 'Aucun autre membre disponible pour le transfert.');
        return;
    }
    
    document.getElementById('assignModal').classList.remove('hidden');
}

function fermerModalAssign() {
    document.getElementById('assignModal').classList.add('hidden');
}

function terminerTache(tacheId) {
    document.getElementById('completeTacheId').value = tacheId;
    document.getElementById('completeModal').classList.remove('hidden');
}

function fermerModalComplete() {
    document.getElementById('completeModal').classList.add('hidden');
}

function confirmerAssignation() {
    const tacheId = document.getElementById('tacheId').value;
    const responsableId = document.getElementById('responsable_id').value;
    
    if (!responsableId) {
        afficherMessage('error', 'Veuillez sélectionner un responsable');
        return;
    }
    
    const submitBtn = document.querySelector('#assignModal button[onclick="confirmerAssignation()"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Traitement...';
    
    fetch(`{% url 'assigner_tache_etape' projet.id etape.id '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', tacheId), {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `responsable_id=${responsableId}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            fermerModalAssign();
            afficherMessage('success', isTransferMode ? 'Tâche transférée avec succès !' : 'Tâche assignée avec succès !');
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            afficherMessage('error', 'Erreur: ' + data.error);
        }
    })
    .catch(error => {
        afficherMessage('error', 'Erreur de communication avec le serveur');
    })
    .finally(() => {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    });
}

function confirmerTerminer() {
    const tacheId = document.getElementById('completeTacheId').value;
    const submitBtn = document.querySelector('#completeModal button[onclick="confirmerTerminer()"]');
    const originalText = submitBtn.innerHTML;
    
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Finalisation...';
    
    fetch(`{% url 'terminer_tache_etape' projet.id etape.id '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', tacheId), {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/x-www-form-urlencoded',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            fermerModalComplete();
            afficherMessage('success', 'Tâche terminée avec succès !');
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            afficherMessage('error', 'Erreur: ' + data.error);
        }
    })
    .catch(error => {
        afficherMessage('error', 'Erreur de communication avec le serveur');
    })
    .finally(() => {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    });
}

// Fonction pour afficher les messages
function afficherMessage(type, message) {
    // Créer un élément de notification
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 z-50 px-4 py-3 rounded-md shadow-lg ${
        type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
    }`;
    notification.innerHTML = `
        <div class="flex items-center">
            <i class="fas fa-${type === 'success' ? 'check' : 'exclamation-triangle'} mr-2"></i>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Supprimer après 3 secondes
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

// Fonction pour gérer les cas de test
function gererCasTests(tacheId, nomTache) {
    document.getElementById('casTestTitle').innerHTML = `<i class="fas fa-vial mr-2"></i>Cas de Test - ${nomTache}`;
    
    // Charger le contenu des cas de test
    const content = document.getElementById('casTestContent');
    content.innerHTML = `
        <div class="text-center py-8">
            <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-spinner fa-spin text-purple-600 text-xl"></i>
            </div>
            <p class="text-gray-600">Chargement des cas de test...</p>
        </div>
    `;
    
    // Simuler le chargement des cas de test (à remplacer par un appel AJAX réel)
    setTimeout(() => {
        content.innerHTML = `
            <div class="space-y-4">
                <!-- Header avec bouton d'ajout -->
                <div class="flex items-center justify-between p-4 bg-purple-50 rounded-lg border border-purple-200">
                    <div>
                        <h4 class="font-semibold text-purple-900">Cas de Test pour: ${nomTache}</h4>
                        <p class="text-sm text-purple-700">Gérez les cas de test individuels pour cette tâche</p>
                    </div>
                    <button onclick="creerNouveauCasTest('${tacheId}')" 
                            class="inline-flex items-center px-3 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-md text-sm font-medium transition-colors">
                        <i class="fas fa-plus mr-2"></i>Nouveau Cas
                    </button>
                </div>
                
                <!-- Liste des cas de test (exemple) -->
                <div class="space-y-3">
                    <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <div class="flex items-center justify-between mb-2">
                            <h5 class="font-medium text-gray-900">AUTH-001 - Connexion avec email valide</h5>
                            <div class="flex items-center space-x-2">
                                <span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-medium">
                                    <i class="fas fa-check mr-1"></i>Passé
                                </span>
                                <button class="text-blue-600 hover:text-blue-800 p-1" title="Exécuter">
                                    <i class="fas fa-play text-sm"></i>
                                </button>
                                <button class="text-gray-600 hover:text-gray-800 p-1" title="Modifier">
                                    <i class="fas fa-edit text-sm"></i>
                                </button>
                            </div>
                        </div>
                        <p class="text-sm text-gray-600 mb-2">Test de connexion avec un email et mot de passe valides</p>
                        <div class="text-xs text-gray-500">
                            <span class="mr-4"><i class="fas fa-user mr-1"></i>Exécuté par: John Doe</span>
                            <span><i class="fas fa-calendar mr-1"></i>05/02/2026 14:30</span>
                        </div>
                    </div>
                    
                    <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <div class="flex items-center justify-between mb-2">
                            <h5 class="font-medium text-gray-900">AUTH-002 - Connexion avec mot de passe incorrect</h5>
                            <div class="flex items-center space-x-2">
                                <span class="px-2 py-1 bg-red-100 text-red-800 rounded-full text-xs font-medium">
                                    <i class="fas fa-times mr-1"></i>Échec
                                </span>
                                <button class="text-blue-600 hover:text-blue-800 p-1" title="Exécuter">
                                    <i class="fas fa-play text-sm"></i>
                                </button>
                                <button class="text-gray-600 hover:text-gray-800 p-1" title="Modifier">
                                    <i class="fas fa-edit text-sm"></i>
                                </button>
                            </div>
                        </div>
                        <p class="text-sm text-gray-600 mb-2">Test de connexion avec un mot de passe incorrect</p>
                        <div class="text-xs text-gray-500">
                            <span class="mr-4"><i class="fas fa-user mr-1"></i>Exécuté par: Jane Smith</span>
                            <span><i class="fas fa-calendar mr-1"></i>05/02/2026 15:15</span>
                        </div>
                    </div>
                </div>
                
                <!-- Statistiques -->
                <div class="grid grid-cols-3 gap-4 mt-6">
                    <div class="text-center p-3 bg-green-50 rounded-lg border border-green-200">
                        <div class="text-2xl font-bold text-green-600">1</div>
                        <div class="text-sm text-green-700">Passés</div>
                    </div>
                    <div class="text-center p-3 bg-red-50 rounded-lg border border-red-200">
                        <div class="text-2xl font-bold text-red-600">1</div>
                        <div class="text-sm text-red-700">Échecs</div>
                    </div>
                    <div class="text-center p-3 bg-gray-50 rounded-lg border border-gray-200">
                        <div class="text-2xl font-bold text-gray-600">50%</div>
                        <div class="text-sm text-gray-700">Réussite</div>
                    </div>
                </div>
            </div>
        `;
    }, 1000);
    
    document.getElementById('casTestModal').classList.remove('hidden');
}

// Fonction pour créer un nouveau cas de test
function creerNouveauCasTest(tacheId) {
    afficherMessage('info', 'Fonctionnalité de création de cas de test en développement');
}

// Fonction pour fermer le modal des cas de test
function fermerModalCasTest() {
    document.getElementById('casTestModal').classList.add('hidden');
}

function creerNouveauCasTest() {
    if (!currentTacheTestId) {
        afficherMessage('error', 'Erreur: Aucune tâche de test sélectionnée');
        return;
    }
    
    // Ouvrir un modal de création ou rediriger vers une page de création
    afficherMessage('info', 'Fonctionnalité de création de cas de test en développement');
}

function executerCasTest(casTestId, statut) {
    const resultats = prompt(`Résultats obtenus pour ce test (${statut === 'PASSE' ? 'succès' : 'échec'}):`);
    if (resultats === null) return; // Annulé
    
    fetch(`{% url 'executer_cas_test' projet.id etape.id '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', casTestId), {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `statut=${statut}&resultats_obtenus=${encodeURIComponent(resultats)}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            afficherMessage('success', data.message);
            // Recharger les cas de test
            chargerCasTests(currentTacheId);
        } else {
            afficherMessage('error', data.error);
        }
    })
    .catch(error => {
        afficherMessage('error', 'Erreur de communication avec le serveur');
    });
}

function voirDetailsCasTest(casTestId) {
    fetch(`{% url 'details_cas_test' projet.id etape.id '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', casTestId), {
        method: 'GET',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Afficher les détails dans un modal ou une section
            alert(`Détails du cas de test:\n\nNom: ${data.cas.nom}\nDescription: ${data.cas.description}\nStatut: ${data.cas.statut_display}\nPriorité: ${data.cas.priorite_display}`);
        } else {
            afficherMessage('error', data.error);
        }
    })
    .catch(error => {
        afficherMessage('error', 'Erreur lors du chargement des détails');
    });
}

// Fonction pour voir les détails de la tâche
function voirDetailsTache(tacheId, nom, description, responsable, dateCreation, progression, etapeStatut) {
    // Debug: afficher le statut reçu
    console.log('=== DEBUG MODAL DÉTAILS ===');
    console.log('Statut de l\'étape reçu:', etapeStatut);
    console.log('Type:', typeof etapeStatut);
    console.log('Longueur:', etapeStatut.length);
    console.log('Comparaison stricte avec TERMINEE:', etapeStatut === 'TERMINEE');
    console.log('Comparaison avec trim:', etapeStatut.trim() === 'TERMINEE');
    
    // Vérifier si l'étape est terminée (avec trim pour éviter les espaces)
    const etapeTerminee = (etapeStatut.trim() === 'TERMINEE');
    console.log('Résultat final etapeTerminee:', etapeTerminee);
    console.log('Boutons d\'action seront affichés:', !etapeTerminee);
    
    // Remplir le contenu du modal
    document.getElementById('detailsContent').innerHTML = `
        <div class="space-y-6">
            <!-- Titre et statut -->
            <div class="border-b border-gray-200 pb-4">
                <h4 class="text-lg font-semibold text-gray-900 mb-2">${nom}</h4>
                <div class="flex items-center space-x-2">
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                        <i class="fas fa-info-circle mr-1"></i>Tâche d'étape
                    </span>
                    ${etapeTerminee ? `
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-700">
                        <i class="fas fa-lock mr-1"></i>Étape terminée
                    </span>
                    ` : ''}
                </div>
            </div>
            
            <!-- Description -->
            <div>
                <h5 class="text-sm font-semibold text-gray-700 mb-2 flex items-center">
                    <i class="fas fa-align-left mr-2 text-gray-500"></i>Description
                </h5>
                <div class="bg-gray-50 rounded-lg p-3 border border-gray-200">
                    <p class="text-sm text-gray-700">${description || 'Aucune description fournie'}</p>
                </div>
            </div>
            
            <!-- Informations générales -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <h5 class="text-sm font-semibold text-gray-700 mb-3 flex items-center">
                        <i class="fas fa-user mr-2 text-gray-500"></i>Assignation
                    </h5>
                    <div class="bg-gray-50 rounded-lg p-3 border border-gray-200">
                        <div class="flex items-center">
                            ${responsable !== 'Non assignée' ? 
                                `<div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center mr-3">
                                    <span class="text-white text-xs font-bold">${responsable.charAt(0)}</span>
                                </div>
                                <span class="text-sm text-gray-700">${responsable}</span>` :
                                `<i class="fas fa-user-slash text-orange-500 mr-2"></i>
                                <span class="text-sm text-orange-600">Non assignée</span>`
                            }
                        </div>
                    </div>
                </div>
                
                <div>
                    <h5 class="text-sm font-semibold text-gray-700 mb-3 flex items-center">
                        <i class="fas fa-calendar-alt mr-2 text-gray-500"></i>Dates
                    </h5>
                    <div class="bg-gray-50 rounded-lg p-3 border border-gray-200">
                        <div class="space-y-1 text-sm text-gray-700">
                            <div class="flex items-center">
                                <i class="fas fa-plus-circle mr-2 text-green-500 w-4"></i>
                                <span>Créée le ${dateCreation}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Progression -->
            ${progression > 0 ? `
            <div>
                <h5 class="text-sm font-semibold text-gray-700 mb-3 flex items-center">
                    <i class="fas fa-chart-line mr-2 text-gray-500"></i>Progression
                </h5>
                <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm text-gray-600">Avancement</span>
                        <span class="text-sm font-semibold text-blue-600">${progression}%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3">
                        <div class="bg-blue-600 h-3 rounded-full transition-all duration-300" style="width: ${progression}%"></div>
                    </div>
                </div>
            </div>
            ` : ''}
            
            <!-- Actions disponibles (seulement si l'étape n'est pas terminée) -->
            ${!etapeTerminee ? `
            <div>
                <h5 class="text-sm font-semibold text-gray-700 mb-3 flex items-center">
                    <i class="fas fa-cogs mr-2 text-gray-500"></i>Actions disponibles
                </h5>
                <div class="flex flex-wrap gap-2">
                    <button onclick="fermerModalDetails(); document.querySelector('[href*=\\'modifier_tache_etape\\'][href*=\\'${tacheId}\\']')?.click()" 
                            class="inline-flex items-center px-3 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-md text-sm font-medium transition-colors">
                        <i class="fas fa-edit mr-2"></i>Modifier
                    </button>
                    ${responsable === 'Non assignée' ? `
                    <button onclick="fermerModalDetails(); assignerTache('${tacheId}')" 
                            class="inline-flex items-center px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md text-sm font-medium transition-colors">
                        <i class="fas fa-user-plus mr-2"></i>Assigner
                    </button>
                    ` : `
                    <button onclick="fermerModalDetails(); transfererTache('${tacheId}')" 
                            class="inline-flex items-center px-3 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-md text-sm font-medium transition-colors">
                        <i class="fas fa-exchange-alt mr-2"></i>Transférer
                    </button>
                    `}
                    <button onclick="fermerModalDetails(); terminerTache('${tacheId}')" 
                            class="inline-flex items-center px-3 py-2 bg-green-600 hover:bg-green-700 text-white rounded-md text-sm font-medium transition-colors">
                        <i class="fas fa-check mr-2"></i>Terminer
                    </button>
                </div>
            </div>
            ` : ''}
        </div>
    `;
    
    // Afficher le modal
    document.getElementById('detailsModal').classList.remove('hidden');
}

// Fonction pour fermer le modal des détails
function fermerModalDetails() {
    document.getElementById('detailsModal').classList.add('hidden');
}

// Fermer modales en cliquant à l'extérieur
document.getElementById('assignModal').addEventListener('click', function(e) {
    if (e.target === this) fermerModalAssign();
});

document.getElementById('completeModal').addEventListener('click', function(e) {
    if (e.target === this) fermerModalComplete();
});

document.getElementById('casTestModal').addEventListener('click', function(e) {
    if (e.target === this) fermerModalCasTest();
});

document.getElementById('creerCasTestModal').addEventListener('click', function(e) {
    if (e.target === this) fermerModalCreerCasTest();
});

document.getElementById('detailsModal').addEventListener('click', function(e) {
    if (e.target === this) fermerModalDetails();
});

// Fermer modales avec Escape
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        fermerModalAssign();
        fermerModalComplete();
        fermerModalCasTest();
        fermerModalCreerCasTest();
        fermerModalDetails();
    }
});

// Fonction pour imprimer le rapport d'une tâche terminée
function imprimerRapportTache(tacheId, tacheNom) {
    // Créer une fenêtre pour le rapport
    const printWindow = window.open('', '_blank');
    
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Rapport de Tests - ${tacheNom}</title>
            <style>
                body {
                    font-family: Arial, sans-serif;
                    padding: 20px;
                    color: #333;
                    max-width: 1200px;
                    margin: 0 auto;
                }
                .header {
                    text-align: center;
                    border-bottom: 3px solid #333;
                    padding-bottom: 20px;
                    margin-bottom: 30px;
                }
                .header h1 {
                    font-size: 28px;
                    margin: 0 0 10px 0;
                    color: #1a1a1a;
                }
                .header h2 {
                    font-size: 20px;
                    color: #666;
                    margin: 5px 0;
                }
                .stats-grid {
                    display: grid;
                    grid-template-columns: repeat(3, 1fr);
                    gap: 15px;
                    margin-bottom: 30px;
                }
                .stat-card {
                    border: 1px solid #ddd;
                    padding: 15px;
                    border-radius: 5px;
                    text-align: center;
                }
                .stat-card.success {
                    border-color: #10B981;
                    background: #ECFDF5;
                }
                .stat-card.error {
                    border-color: #EF4444;
                    background: #FEF2F2;
                }
                .stat-card.info {
                    border-color: #3B82F6;
                    background: #EFF6FF;
                }
                .stat-card.warning {
                    border-color: #F59E0B;
                    background: #FFFBEB;
                }
                .stat-card.purple {
                    border-color: #8B5CF6;
                    background: #F5F3FF;
                }
                .stat-label {
                    margin: 0;
                    font-size: 14px;
                    color: #666;
                }
                .stat-value {
                    margin: 5px 0 0 0;
                    font-size: 32px;
                    font-weight: bold;
                }
                .stat-card.success .stat-value { color: #059669; }
                .stat-card.error .stat-value { color: #DC2626; }
                .stat-card.info .stat-value { color: #2563EB; }
                .stat-card.warning .stat-value { color: #D97706; }
                .stat-card.purple .stat-value { color: #7C3AED; }
                
                .section-title {
                    font-size: 20px;
                    font-weight: bold;
                    border-bottom: 2px solid #ddd;
                    padding-bottom: 10px;
                    margin: 30px 0 20px 0;
                }
                
                table {
                    width: 100%;
                    border-collapse: collapse;
                    margin-bottom: 30px;
                }
                th {
                    background: #f3f4f6;
                    padding: 12px;
                    text-align: left;
                    font-weight: bold;
                    border: 1px solid #ddd;
                    font-size: 12px;
                    text-transform: uppercase;
                }
                td {
                    padding: 10px 12px;
                    border: 1px solid #ddd;
                    font-size: 13px;
                }
                tr:nth-child(even) {
                    background: #f9fafb;
                }
                
                .badge {
                    display: inline-block;
                    padding: 4px 10px;
                    border-radius: 12px;
                    font-size: 11px;
                    font-weight: bold;
                }
                .badge-success { background: #D1FAE5; color: #065F46; }
                .badge-error { background: #FEE2E2; color: #991B1B; }
                .badge-info { background: #DBEAFE; color: #1E40AF; }
                .badge-warning { background: #FEF3C7; color: #92400E; }
                .badge-gray { background: #F3F4F6; color: #374151; }
                
                .footer {
                    margin-top: 40px;
                    padding-top: 20px;
                    border-top: 2px solid #333;
                    text-align: center;
                    font-size: 12px;
                    color: #666;
                }
                
                .loading {
                    text-align: center;
                    padding: 40px;
                    font-size: 18px;
                    color: #666;
                }
                
                @media print {
                    body { padding: 10px; }
                    .stat-card { page-break-inside: avoid; }
                    table { page-break-inside: auto; }
                    tr { page-break-inside: avoid; page-break-after: auto; }
                }
            </style>
        </head>
        <body>
            <div class="loading">⏳ Chargement des données...</div>
        </body>
        </html>
    `);
    
    // Charger les données via l'API
    fetch('{% url "api_cas_tests_tache" projet.id etape.id "00000000-0000-0000-0000-000000000000" %}'.replace('00000000-0000-0000-0000-000000000000', tacheId))
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const stats = data.stats;
                const casTests = data.cas_tests;
                
                // Générer le tableau des cas de test
                let tableRows = '';
                casTests.forEach((cas, index) => {
                    let statutBadge = '';
                    if (cas.statut === 'PASSE') {
                        statutBadge = '<span class="badge badge-success">✓ ' + cas.statut_display + '</span>';
                    } else if (cas.statut === 'ECHEC') {
                        statutBadge = '<span class="badge badge-error">✗ ' + cas.statut_display + '</span>';
                    } else if (cas.statut === 'EN_COURS') {
                        statutBadge = '<span class="badge badge-info">▶ ' + cas.statut_display + '</span>';
                    } else if (cas.statut === 'BLOQUE') {
                        statutBadge = '<span class="badge badge-warning">⊘ ' + cas.statut_display + '</span>';
                    } else {
                        statutBadge = '<span class="badge badge-gray">○ ' + cas.statut_display + '</span>';
                    }
                    
                    tableRows += '<tr>' +
                        '<td style="text-align: center; font-weight: bold;">' + (index + 1) + '</td>' +
                        '<td style="font-family: monospace; font-weight: bold;">' + cas.numero_cas + '</td>' +
                        '<td><strong>' + cas.nom + '</strong><br><small style="color: #666;">' + cas.description + '</small></td>' +
                        '<td style="text-align: center;">' + statutBadge + '</td>' +
                        '<td style="text-align: center;">' + cas.priorite + '</td>' +
                        '<td>' + cas.executeur + '</td>' +
                        '<td style="font-size: 11px;">' + cas.date_execution + '</td>' +
                        '<td style="font-size: 11px;">' + cas.resultats_obtenus + '</td>' +
                        '</tr>';
                });
                
                // Générer le tableau HTML
                let tableHTML = '';
                if (casTests.length > 0) {
                    tableHTML = '<table>' +
                        '<thead><tr>' +
                        '<th style="width: 40px;">#</th>' +
                        '<th style="width: 100px;">Numéro</th>' +
                        '<th>Cas de Test</th>' +
                        '<th style="width: 100px;">Statut</th>' +
                        '<th style="width: 80px;">Priorité</th>' +
                        '<th style="width: 120px;">Exécuteur</th>' +
                        '<th style="width: 120px;">Date</th>' +
                        '<th style="width: 200px;">Résultats</th>' +
                        '</tr></thead>' +
                        '<tbody>' + tableRows + '</tbody>' +
                        '</table>';
                } else {
                    tableHTML = '<p style="text-align: center; padding: 40px; color: #999;">Aucun cas de test disponible</p>';
                }
                
                // Générer le contenu complet
                printWindow.document.body.innerHTML = 
                    '<div class="header">' +
                        '<h1>📋 Rapport de Tests</h1>' +
                        '<h2>' + data.projet.nom + '</h2>' +
                        '<p style="font-size: 16px; margin: 10px 0;">' + data.etape.nom + ' - ' + tacheNom + '</p>' +
                        '<p style="font-size: 14px; color: #999;">Généré le ' + new Date().toLocaleString('fr-FR', { 
                            day: '2-digit', 
                            month: '2-digit', 
                            year: 'numeric', 
                            hour: '2-digit', 
                            minute: '2-digit' 
                        }) + '</p>' +
                    '</div>' +
                    '<h3 class="section-title">📊 Statistiques Globales</h3>' +
                    '<div class="stats-grid">' +
                        '<div class="stat-card">' +
                            '<p class="stat-label">Total des cas</p>' +
                            '<p class="stat-value">' + stats.total + '</p>' +
                        '</div>' +
                        '<div class="stat-card success">' +
                            '<p class="stat-label">Cas passés</p>' +
                            '<p class="stat-value">' + stats.passes + '</p>' +
                        '</div>' +
                        '<div class="stat-card error">' +
                            '<p class="stat-label">Cas échoués</p>' +
                            '<p class="stat-value">' + stats.echecs + '</p>' +
                        '</div>' +
                        '<div class="stat-card info">' +
                            '<p class="stat-label">En cours</p>' +
                            '<p class="stat-value">' + stats.en_cours + '</p>' +
                        '</div>' +
                        '<div class="stat-card warning">' +
                            '<p class="stat-label">Bloqués</p>' +
                            '<p class="stat-value">' + stats.bloques + '</p>' +
                        '</div>' +
                        '<div class="stat-card purple">' +
                            '<p class="stat-label">Taux de réussite</p>' +
                            '<p class="stat-value">' + stats.pourcentage_reussite + '%</p>' +
                        '</div>' +
                    '</div>' +
                    '<h3 class="section-title">📝 Détails des Cas de Test</h3>' +
                    tableHTML +
                    '<div class="footer">' +
                        '<p><strong>' + data.projet.nom + '</strong> - Rapport de tests généré le ' + new Date().toLocaleString('fr-FR') + '</p>' +
                        '<p>SI-Gouvernance JCM</p>' +
                    '</div>';
                
                // Attendre un peu puis imprimer
                setTimeout(function() {
                    printWindow.print();
                }, 500);
            } else {
                printWindow.document.body.innerHTML = 
                    '<div class="header">' +
                        '<h1>Rapport de Tests</h1>' +
                        '<h2>{{ projet.nom }}</h2>' +
                        '<p>{{ etape.type_etape.get_nom_display }} - ' + tacheNom + '</p>' +
                    '</div>' +
                    '<div style="text-align: center; padding: 40px; color: #DC2626;">' +
                        '<p style="font-size: 18px;">❌ Erreur lors du chargement des données</p>' +
                        '<p style="font-size: 14px;">' + data.error + '</p>' +
                    '</div>';
            }
        })
        .catch(function(error) {
            printWindow.document.body.innerHTML = 
                '<div class="header">' +
                    '<h1>Rapport de Tests</h1>' +
                    '<h2>{{ projet.nom }}</h2>' +
                    '<p>{{ etape.type_etape.get_nom_display }} - ' + tacheNom + '</p>' +
                '</div>' +
                '<div style="text-align: center; padding: 40px; color: #DC2626;">' +
                    '<p style="font-size: 18px;">❌ Erreur de communication</p>' +
                    '<p style="font-size: 14px;">' + error.message + '</p>' +
                '</div>';
        });
}
</script>
{% endblock %}