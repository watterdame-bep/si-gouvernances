{% extends 'base.html' %}

{% block title %}Tâches - {{ etape.type_etape.get_nom_display }} - {{ projet.nom }} - SI-Gouvernance JCM{% endblock %}
{% block page_title %}Gestion des Tâches - {{ etape.type_etape.get_nom_display }}{% endblock %}

{% block extra_css %}
<style>
.line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.status-badge {
    @apply inline-flex items-center px-2 py-1 rounded-full text-xs font-medium;
}

.status-a-faire { @apply bg-gray-100 text-gray-800; }
.status-en-cours { @apply bg-blue-100 text-blue-800; }
.status-terminee { @apply bg-green-100 text-green-800; }
.status-bloquee { @apply bg-red-100 text-red-800; }

.priority-badge {
    @apply inline-flex items-center px-2 py-1 rounded-full text-xs font-medium;
}

.priority-basse { @apply bg-gray-100 text-gray-600; }
.priority-moyenne { @apply bg-blue-100 text-blue-700; }
.priority-haute { @apply bg-orange-100 text-orange-700; }
.priority-critique { @apply bg-red-100 text-red-700; }
</style>
{% endblock %}

{% block content %}
<div class="bg-gray-50 min-h-screen p-4">
    <div class="max-w-7xl mx-auto space-y-4">
        
        <!-- Header professionnel -->
        <div class="bg-white rounded-lg p-4 shadow-sm border border-gray-200">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 rounded-lg flex items-center justify-center shadow-sm
                        {% if etape.statut == 'TERMINEE' %}bg-green-100 border border-green-200
                        {% elif etape.statut == 'EN_COURS' %}bg-blue-100 border border-blue-200
                        {% else %}bg-gray-100 border border-gray-200{% endif %}">
                        <i class="fas fa-tasks text-lg
                            {% if etape.statut == 'TERMINEE' %}text-green-600
                            {% elif etape.statut == 'EN_COURS' %}text-blue-600
                            {% else %}text-gray-600{% endif %}"></i>
                    </div>
                    <div>
                        <h1 class="text-lg font-semibold text-gray-900">Tâches de l'Étape</h1>
                        <p class="text-sm text-gray-600">
                            <i class="fas fa-layer-group mr-1"></i>
                            {{ etape.type_etape.get_nom_display }} • {{ projet.nom }}
                        </p>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    {% if can_create %}
                    <a href="{% url 'creer_tache_etape' projet.id etape.id %}" 
                       class="inline-flex items-center px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-md text-sm transition-colors">
                        <i class="fas fa-plus mr-2"></i>Nouvelle Tâche
                    </a>
                    {% endif %}
                    <a href="{% url 'detail_etape' projet.id etape.id %}" 
                       class="inline-flex items-center px-3 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-md font-medium text-sm transition-colors">
                        <i class="fas fa-arrow-left mr-2"></i>Retour
                    </a>
                </div>
            </div>
        </div>

        <!-- Message informatif pour étapes terminées -->
        {% if etape_terminee and can_create %}
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
            <div class="flex items-start space-x-3">
                <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center flex-shrink-0">
                    <i class="fas fa-info-circle text-blue-600"></i>
                </div>
                <div class="flex-1">
                    <h3 class="text-sm font-medium text-blue-800 mb-1">
                        Étape terminée - Ajout de tâches possible
                    </h3>
                    <p class="text-sm text-blue-700">
                        Cette étape est terminée, mais vous pouvez encore ajouter des tâches si nécessaire (avec justification). 
                        Cela peut être utile si vous avez oublié quelque chose ou si de nouveaux besoins sont identifiés.
                    </p>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Statistiques de l'étape -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="bg-white rounded-lg p-4 shadow-sm border border-gray-200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Statut Étape</p>
                        <p class="text-lg font-bold
                            {% if etape.statut == 'TERMINEE' %}text-green-600
                            {% elif etape.statut == 'EN_COURS' %}text-blue-600
                            {% else %}text-gray-600{% endif %}">
                            {% if etape.statut == 'TERMINEE' %}Terminée
                            {% elif etape.statut == 'EN_COURS' %}En Cours
                            {% else %}À Venir{% endif %}
                        </p>
                    </div>
                    <div class="w-10 h-10 rounded-lg flex items-center justify-center
                        {% if etape.statut == 'TERMINEE' %}bg-green-100
                        {% elif etape.statut == 'EN_COURS' %}bg-blue-100
                        {% else %}bg-gray-100{% endif %}">
                        <i class="fas 
                            {% if etape.statut == 'TERMINEE' %}fa-check text-green-600
                            {% elif etape.statut == 'EN_COURS' %}fa-play text-blue-600
                            {% else %}fa-clock text-gray-600{% endif %}"></i>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg p-4 shadow-sm border border-gray-200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Total Tâches</p>
                        <p class="text-2xl font-bold text-gray-900">{{ taches.count }}</p>
                    </div>
                    <div class="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-list text-gray-600"></i>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg p-4 shadow-sm border border-gray-200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Terminées</p>
                        <p class="text-2xl font-bold text-green-600">{{ taches_terminees.count }}</p>
                    </div>
                    <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-check text-green-600"></i>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg p-4 shadow-sm border border-gray-200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Progression</p>
                        <p class="text-2xl font-bold text-purple-600">
                            {% if taches.count > 0 %}
                                {% widthratio taches_terminees.count taches.count 100 %}%
                            {% else %}
                                0%
                            {% endif %}
                        </p>
                    </div>
                    <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-chart-line text-purple-600"></i>
                    </div>
                </div>
            </div>
        </div>
        <!-- Liste des tâches -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
            <div class="p-4 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <i class="fas fa-list text-gray-600 mr-2"></i>
                        <h2 class="text-lg font-semibold text-gray-900">Tâches de l'Étape</h2>
                    </div>
                    <span class="text-sm text-gray-500">{{ taches.count }} tâche{{ taches.count|pluralize }}</span>
                </div>
            </div>
            
            {% if taches %}
            <div class="divide-y divide-gray-200">
                {% for tache in taches %}
                <div class="p-4 hover:bg-gray-50 transition-colors" data-tache-id="{{ tache.id }}" data-responsable-id="{% if tache.responsable %}{{ tache.responsable.id }}{% endif %}">
                    <div class="flex items-start justify-between">
                        <div class="flex-1 min-w-0">
                            <!-- Titre et badges -->
                            <div class="flex items-center space-x-3 mb-2">
                                <h3 class="text-sm font-semibold text-gray-900 truncate">{{ tache.nom }}</h3>
                                
                                <!-- Badge tâche spéciale -->
                                {% if tache.ajoutee_apres_cloture %}
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 border border-yellow-300">
                                    <i class="fas fa-star mr-1"></i>Tâche Spéciale
                                </span>
                                {% endif %}
                                
                                <!-- Badge statut -->
                                <span class="status-badge status-{{ tache.statut|lower }}">
                                    {% if tache.statut == 'A_FAIRE' %}
                                        <i class="fas fa-clock mr-1"></i>À Faire
                                    {% elif tache.statut == 'EN_COURS' %}
                                        <i class="fas fa-play mr-1"></i>En Cours
                                    {% elif tache.statut == 'TERMINEE' %}
                                        <i class="fas fa-check mr-1"></i>Terminée
                                    {% elif tache.statut == 'BLOQUEE' %}
                                        <i class="fas fa-exclamation-triangle mr-1"></i>Bloquée
                                    {% endif %}
                                </span>
                                
                                <!-- Badge priorité -->
                                <span class="priority-badge priority-{{ tache.priorite|lower }}">
                                    {% if tache.priorite == 'CRITIQUE' %}
                                        <i class="fas fa-exclamation-circle mr-1"></i>Critique
                                    {% elif tache.priorite == 'HAUTE' %}
                                        <i class="fas fa-arrow-up mr-1"></i>Haute
                                    {% elif tache.priorite == 'MOYENNE' %}
                                        <i class="fas fa-minus mr-1"></i>Moyenne
                                    {% else %}
                                        <i class="fas fa-arrow-down mr-1"></i>Basse
                                    {% endif %}
                                </span>
                            </div>
                            
                            <!-- Description -->
                            {% if tache.description %}
                            <p class="text-sm text-gray-600 mb-2 line-clamp-2">{{ tache.description }}</p>
                            {% endif %}
                            
                            <!-- Responsable et dates -->
                            <div class="flex items-center space-x-4 text-xs text-gray-500">
                                {% if tache.responsable %}
                                <span class="flex items-center">
                                    <i class="fas fa-user mr-1"></i>{{ tache.responsable.get_full_name }}
                                </span>
                                {% else %}
                                <span class="text-orange-600 flex items-center">
                                    <i class="fas fa-exclamation-triangle mr-1"></i>Non assignée
                                </span>
                                {% endif %}
                                
                                <span class="flex items-center">
                                    <i class="fas fa-calendar-alt mr-1"></i>{{ tache.date_creation|date:"d/m/Y" }}
                                </span>
                                
                                {% if tache.date_debut or tache.date_fin %}
                                <span class="flex items-center">
                                    <i class="fas fa-calendar-check mr-1"></i>
                                    {% if tache.date_debut and tache.date_fin %}
                                        {{ tache.date_debut|date:"d/m" }} - {{ tache.date_fin|date:"d/m" }}
                                    {% elif tache.date_debut %}
                                        Dès {{ tache.date_debut|date:"d/m" }}
                                    {% elif tache.date_fin %}
                                        Avant {{ tache.date_fin|date:"d/m" }}
                                    {% endif %}
                                </span>
                                {% endif %}
                                
                                {% if tache.pourcentage_completion > 0 %}
                                <span class="flex items-center">
                                    <i class="fas fa-chart-pie mr-1"></i>{{ tache.pourcentage_completion }}%
                                </span>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Actions -->
                        {% if can_create %}
                        <div class="flex items-center space-x-1 ml-4">
                            {% if not tache.responsable and tache.statut != 'TERMINEE' %}
                            <!-- Bouton Assigner -->
                            <button onclick="assignerTache('{{ tache.id }}')"
                                    class="inline-flex items-center px-2 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded text-xs font-medium transition-colors"
                                    title="Assigner">
                                <i class="fas fa-user-plus"></i>
                            </button>
                            {% elif tache.responsable and tache.statut != 'TERMINEE' %}
                            <!-- Bouton Transférer -->
                            <button onclick="transfererTache('{{ tache.id }}')"
                                    class="inline-flex items-center px-2 py-1 bg-indigo-600 hover:bg-indigo-700 text-white rounded text-xs font-medium transition-colors"
                                    title="Transférer">
                                <i class="fas fa-exchange-alt"></i>
                            </button>
                            {% endif %}
                            
                            {% if tache.statut != 'TERMINEE' %}
                            <!-- Bouton Terminer -->
                            <button onclick="terminerTache('{{ tache.id }}')"
                                    class="inline-flex items-center px-2 py-1 bg-green-600 hover:bg-green-700 text-white rounded text-xs font-medium transition-colors"
                                    title="Terminer">
                                <i class="fas fa-check"></i>
                            </button>
                            
                            <!-- Bouton Modifier -->
                            <a href="{% url 'modifier_tache_etape' projet.id etape.id tache.id %}"
                               class="inline-flex items-center px-2 py-1 bg-gray-600 hover:bg-gray-700 text-white rounded text-xs font-medium transition-colors"
                               title="Modifier">
                                <i class="fas fa-edit"></i>
                            </a>
                            {% else %}
                            <!-- Tâche terminée -->
                            <span class="inline-flex items-center px-2 py-1 bg-gray-100 text-gray-500 rounded text-xs font-medium"
                                  title="Tâche terminée">
                                <i class="fas fa-lock mr-1"></i>Terminée
                            </span>
                            {% endif %}
                            
                            <!-- Bouton Détails -->
                            <button onclick="voirDetailsTache('{{ tache.id }}', '{{ tache.nom|escapejs }}')"
                                    class="inline-flex items-center px-2 py-1 bg-purple-600 hover:bg-purple-700 text-white rounded text-xs font-medium transition-colors"
                                    title="Détails">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <!-- État vide -->
            <div class="p-8 text-center">
                <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-tasks text-gray-400 text-xl"></i>
                </div>
                <h3 class="text-base font-medium text-gray-500 mb-2">Aucune tâche créée</h3>
                <p class="text-sm text-gray-400 mb-4">Créez votre première tâche pour organiser le travail sur cette étape</p>
                {% if can_create %}
                <a href="{% url 'creer_tache_etape' projet.id etape.id %}" 
                   class="inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-md text-sm transition-colors">
                    <i class="fas fa-plus mr-2"></i>Créer une Tâche
                </a>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal Assigner/Transférer Tâche -->
<div id="assignModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
        <div class="bg-blue-600 rounded-t-lg px-4 py-3 text-white">
            <h3 class="text-lg font-semibold" id="assignTitle">
                <i class="fas fa-user-plus mr-2"></i>Assigner la tâche
            </h3>
        </div>
        
        <form id="assignForm" class="p-4 space-y-4">
            {% csrf_token %}
            <input type="hidden" id="tacheId" name="tache_id">
            
            <div>
                <label for="responsable_id" class="block text-sm font-medium text-gray-700 mb-1">
                    <i class="fas fa-user text-blue-600 mr-1"></i>
                    Responsable
                </label>
                <select id="responsable_id" name="responsable_id" required 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="">Sélectionner un responsable...</option>
                    {% for membre in equipe %}
                    <option value="{{ membre.id }}">{{ membre.get_full_name }}</option>
                    {% endfor %}
                </select>
            </div>
        </form>
        
        <div class="bg-gray-50 rounded-b-lg px-4 py-3 flex items-center justify-end space-x-3">
            <button onclick="fermerModalAssign()" 
                    class="px-3 py-1.5 text-gray-600 hover:text-gray-800 font-medium text-sm transition-colors">
                Annuler
            </button>
            <button onclick="confirmerAssignation()" 
                    class="px-4 py-1.5 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-md text-sm transition-colors">
                <i class="fas fa-check mr-1"></i>Confirmer
            </button>
        </div>
    </div>
</div>

<!-- Modal Terminer Tâche -->
<div id="completeModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
        <div class="bg-green-600 rounded-t-lg px-4 py-3 text-white">
            <h3 class="text-lg font-semibold">
                <i class="fas fa-check-circle mr-2"></i>Terminer la tâche
            </h3>
        </div>
        
        <div class="p-4 text-center">
            <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-check text-green-600 text-xl"></i>
            </div>
            <p class="text-gray-600 mb-4">Confirmer que cette tâche est terminée ?</p>
            
            <form id="completeForm">
                {% csrf_token %}
                <input type="hidden" id="completeTacheId" name="tache_id">
            </form>
        </div>
        
        <div class="bg-gray-50 rounded-b-lg px-4 py-3 flex items-center justify-end space-x-3">
            <button onclick="fermerModalComplete()" 
                    class="px-3 py-1.5 text-gray-600 hover:text-gray-800 font-medium text-sm transition-colors">
                Annuler
            </button>
            <button onclick="confirmerTerminer()" 
                    class="px-4 py-1.5 bg-green-600 hover:bg-green-700 text-white font-medium rounded-md text-sm transition-colors">
                <i class="fas fa-check mr-1"></i>Terminer
            </button>
        </div>
    </div>
</div>

<script>
let isTransferMode = false;

function assignerTache(tacheId) {
    isTransferMode = false;
    document.getElementById('assignTitle').innerHTML = '<i class="fas fa-user-plus mr-2"></i>Assigner la tâche';
    document.getElementById('tacheId').value = tacheId;
    
    // Réinitialiser le select
    const select = document.getElementById('responsable_id');
    select.selectedIndex = 0;
    const options = select.querySelectorAll('option');
    options.forEach(option => option.style.display = 'block');
    
    document.getElementById('assignModal').classList.remove('hidden');
}

function transfererTache(tacheId) {
    isTransferMode = true;
    document.getElementById('assignTitle').innerHTML = '<i class="fas fa-exchange-alt mr-2"></i>Transférer la tâche';
    document.getElementById('tacheId').value = tacheId;
    
    // Masquer le responsable actuel
    const tacheElement = document.querySelector(`[data-tache-id="${tacheId}"]`);
    const responsableActuelId = tacheElement ? tacheElement.getAttribute('data-responsable-id') : null;
    
    const select = document.getElementById('responsable_id');
    select.selectedIndex = 0;
    const options = select.querySelectorAll('option');
    
    let optionsDisponibles = 0;
    options.forEach(option => {
        if (option.value === '' || option.value === responsableActuelId) {
            option.style.display = 'none';
        } else {
            option.style.display = 'block';
            optionsDisponibles++;
        }
    });
    
    if (optionsDisponibles === 0) {
        afficherMessage('error', 'Aucun autre membre disponible pour le transfert.');
        return;
    }
    
    document.getElementById('assignModal').classList.remove('hidden');
}

function fermerModalAssign() {
    document.getElementById('assignModal').classList.add('hidden');
}

function terminerTache(tacheId) {
    document.getElementById('completeTacheId').value = tacheId;
    document.getElementById('completeModal').classList.remove('hidden');
}

function fermerModalComplete() {
    document.getElementById('completeModal').classList.add('hidden');
}

function confirmerAssignation() {
    const tacheId = document.getElementById('tacheId').value;
    const responsableId = document.getElementById('responsable_id').value;
    
    if (!responsableId) {
        afficherMessage('error', 'Veuillez sélectionner un responsable');
        return;
    }
    
    const submitBtn = document.querySelector('#assignModal button[onclick="confirmerAssignation()"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Traitement...';
    
    fetch(`{% url 'assigner_tache_etape' projet.id etape.id '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', tacheId), {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `responsable_id=${responsableId}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            fermerModalAssign();
            afficherMessage('success', isTransferMode ? 'Tâche transférée avec succès !' : 'Tâche assignée avec succès !');
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            afficherMessage('error', 'Erreur: ' + data.error);
        }
    })
    .catch(error => {
        afficherMessage('error', 'Erreur de communication avec le serveur');
    })
    .finally(() => {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    });
}

function confirmerTerminer() {
    const tacheId = document.getElementById('completeTacheId').value;
    const submitBtn = document.querySelector('#completeModal button[onclick="confirmerTerminer()"]');
    const originalText = submitBtn.innerHTML;
    
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Finalisation...';
    
    fetch(`{% url 'terminer_tache_etape' projet.id etape.id '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', tacheId), {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/x-www-form-urlencoded',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            fermerModalComplete();
            afficherMessage('success', 'Tâche terminée avec succès !');
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            afficherMessage('error', 'Erreur: ' + data.error);
        }
    })
    .catch(error => {
        afficherMessage('error', 'Erreur de communication avec le serveur');
    })
    .finally(() => {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    });
}

// Fonction pour afficher les messages
function afficherMessage(type, message) {
    // Créer un élément de notification
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 z-50 px-4 py-3 rounded-md shadow-lg ${
        type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
    }`;
    notification.innerHTML = `
        <div class="flex items-center">
            <i class="fas fa-${type === 'success' ? 'check' : 'exclamation-triangle'} mr-2"></i>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Supprimer après 3 secondes
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

// Fonction pour voir les détails (placeholder)
function voirDetailsTache(tacheId, nomTache) {
    afficherMessage('info', `Détails de la tâche "${nomTache}" - Fonctionnalité en développement`);
}

// Fermer modales en cliquant à l'extérieur
document.getElementById('assignModal').addEventListener('click', function(e) {
    if (e.target === this) fermerModalAssign();
});

document.getElementById('completeModal').addEventListener('click', function(e) {
    if (e.target === this) fermerModalComplete();
});

// Fermer modales avec Escape
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        fermerModalAssign();
        fermerModalComplete();
    }
});
</script>
{% endblock %}