{% extends 'base.html' %}

{% block title %}Gestion des Comptes - SI-Gouvernance JCM{% endblock %}
{% block page_title %}Gestion des Comptes{% endblock %}

{% block content %}
<div class="bg-gray-50 min-h-screen p-2 md:p-4">
    <div class="max-w-7xl mx-auto space-y-3 md:space-y-4">
        
        <!-- Header Modern -->
        <div class="bg-white rounded-lg p-3 md:p-4 shadow-md border border-white/20">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-lg flex items-center justify-center shadow-md">
                        <span class="text-white font-bold text-sm">üîê</span>
                    </div>
                    <div>
                        <h1 class="text-lg md:text-xl font-bold text-gray-900">Gestion des Comptes</h1>
                        <p class="text-xs md:text-sm text-gray-600">Acc√®s syst√®me - {{ stats.total }} compte{{ stats.total|pluralize }}</p>
                    </div>
                </div>
                <div class="flex space-x-2">
                    <a href="{% url 'gestion_membres' %}" class="group flex items-center px-3 py-2 md:px-4 md:py-2 bg-gradient-to-r from-emerald-500 to-teal-600 hover:from-emerald-600 hover:to-teal-700 text-white rounded-lg font-semibold shadow-md hover:shadow-lg transform hover:scale-105 transition-all duration-300 text-sm">
                        <span class="mr-2">üë•</span>
                        <span class="hidden sm:inline">Profils RH</span>
                        <span class="sm:hidden">Profils</span>
                    </a>
                </div>
            </div>
        </div>

        <!-- Statistiques Compactes -->
        <div class="grid grid-cols-2 md:grid-cols-5 gap-2 md:gap-3">
            <div class="bg-white rounded-lg shadow-md border border-white/20 p-3 hover:shadow-lg transition-shadow">
                <div class="flex items-center">
                    <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center mr-2">
                        <span class="text-blue-600 text-sm">üîê</span>
                    </div>
                    <div>
                        <p class="text-xs font-medium text-gray-500">Total</p>
                        <p class="text-lg font-bold text-gray-900">{{ stats.total }}</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md border border-white/20 p-3 hover:shadow-lg transition-shadow">
                <div class="flex items-center">
                    <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center mr-2">
                        <span class="text-green-600 text-sm">‚úÖ</span>
                    </div>
                    <div>
                        <p class="text-xs font-medium text-gray-500">Actifs</p>
                        <p class="text-lg font-bold text-gray-900">{{ stats.actifs }}</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md border border-white/20 p-3 hover:shadow-lg transition-shadow">
                <div class="flex items-center">
                    <div class="w-8 h-8 bg-gray-100 rounded-lg flex items-center justify-center mr-2">
                        <span class="text-gray-600 text-sm">‚ùå</span>
                    </div>
                    <div>
                        <p class="text-xs font-medium text-gray-500">Inactifs</p>
                        <p class="text-lg font-bold text-gray-900">{{ stats.inactifs }}</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md border border-white/20 p-3 hover:shadow-lg transition-shadow">
                <div class="flex items-center">
                    <div class="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center mr-2">
                        <span class="text-purple-600 text-sm">üëë</span>
                    </div>
                    <div>
                        <p class="text-xs font-medium text-gray-500">Admins</p>
                        <p class="text-lg font-bold text-gray-900">{{ stats.super_admins }}</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md border border-white/20 p-3 hover:shadow-lg transition-shadow">
                <div class="flex items-center">
                    <div class="w-8 h-8 bg-emerald-100 rounded-lg flex items-center justify-center mr-2">
                        <span class="text-emerald-600 text-sm">üë•</span>
                    </div>
                    <div>
                        <p class="text-xs font-medium text-gray-500">Avec profil</p>
                        <p class="text-lg font-bold text-gray-900">{{ stats.avec_membre }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filtres Compacts -->
        <div class="bg-white rounded-lg p-3 md:p-4 shadow-md border border-white/20">
            <form method="get" class="grid grid-cols-1 md:grid-cols-5 gap-3">
                <!-- Search -->
                <div class="md:col-span-2">
                    <label for="search" class="block text-xs font-semibold text-gray-700 mb-1">Rechercher</label>
                    <div class="relative">
                        <input 
                            type="text" 
                            id="search" 
                            name="search" 
                            value="{{ search }}"
                            placeholder="Username, email, nom..."
                            class="w-full pl-8 pr-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300 text-sm"
                        >
                        <span class="absolute left-2.5 top-2.5 text-gray-400 text-xs">üîç</span>
                    </div>
                </div>

                <!-- Status Filter -->
                <div>
                    <label for="statut" class="block text-xs font-semibold text-gray-700 mb-1">Statut</label>
                    <select 
                        id="statut" 
                        name="statut"
                        class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300 text-sm"
                    >
                        <option value="">Tous</option>
                        <option value="actif" {% if statut_filter == 'actif' %}selected{% endif %}>Actifs</option>
                        <option value="inactif" {% if statut_filter == 'inactif' %}selected{% endif %}>Inactifs</option>
                        <option value="super_admin" {% if statut_filter == 'super_admin' %}selected{% endif %}>Admins</option>
                    </select>
                </div>

                <!-- Role Filter -->
                <div>
                    <label for="role" class="block text-xs font-semibold text-gray-700 mb-1">R√¥le</label>
                    <select 
                        id="role" 
                        name="role"
                        class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300 text-sm"
                    >
                        <option value="">Tous</option>
                        {% for role in roles_systeme %}
                        <option value="{{ role.nom }}" {% if role_filter == role.nom %}selected{% endif %}>{{ role.get_nom_display }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Search Button -->
                <div class="flex items-end">
                    <button 
                        type="submit"
                        class="w-full bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white px-3 py-2 rounded-lg font-semibold shadow-md hover:shadow-lg transform hover:scale-105 transition-all duration-300 text-sm"
                    >
                        <span class="mr-1">üîç</span>Filtrer
                    </button>
                </div>
            </form>
        </div>

        <!-- Liste des comptes - Design Compact -->
        {% if page_obj.object_list %}
        <div class="space-y-2 md:space-y-3">
            {% for compte in page_obj.object_list %}
            <div class="bg-white rounded-lg p-3 md:p-4 shadow-md border border-white/20 hover:shadow-lg transition-all duration-300">
                <div class="flex flex-col sm:flex-row sm:items-center gap-3">
                    <!-- Account Info -->
                    <div class="flex items-center space-x-3 flex-1 min-w-0">
                        <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-full flex items-center justify-center shadow-md flex-shrink-0">
                            {% if compte.membre %}
                                <span class="text-white font-bold text-sm">{{ compte.membre.get_initiales }}</span>
                            {% else %}
                                <span class="text-white font-bold text-sm">{{ compte.first_name.0|upper }}{{ compte.last_name.0|upper }}</span>
                            {% endif %}
                        </div>
                        <div class="flex-1 min-w-0">
                            <h3 class="text-sm md:text-base font-semibold text-gray-900 truncate">
                                {% if compte.membre %}
                                    {{ compte.membre.get_nom_complet }}
                                {% else %}
                                    {{ compte.get_full_name }}
                                {% endif %}
                            </h3>
                            <p class="text-xs md:text-sm text-gray-600 truncate">{{ compte.username }} ‚Ä¢ {{ compte.email }}</p>
                            <div class="flex flex-wrap items-center gap-1 mt-1">
                                <!-- Role Badge -->
                                <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium
                                    {% if compte.is_superuser %}bg-purple-100 text-purple-800
                                    {% else %}bg-gray-100 text-gray-800{% endif %}">
                                    {% if compte.is_superuser %}
                                        üëë Super Admin
                                    {% else %}
                                        {% if compte.role_systeme %}
                                            üõ°Ô∏è {{ compte.role_systeme.get_nom_display|truncatechars:12 }}
                                        {% else %}
                                            üõ°Ô∏è Aucun r√¥le
                                        {% endif %}
                                    {% endif %}
                                </span>
                                
                                <!-- Status Badge -->
                                {% if compte.statut_actif %}
                                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">
                                        ‚úÖ Actif
                                    </span>
                                {% else %}
                                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-800">
                                        ‚ùå Inactif
                                    </span>
                                {% endif %}
                                
                                <!-- Member Link Badge -->
                                {% if compte.membre %}
                                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-emerald-100 text-emerald-800">
                                        üë• Profil RH li√©
                                    </span>
                                {% else %}
                                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-orange-100 text-orange-800">
                                        ‚ö†Ô∏è Aucun profil
                                    </span>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Account Details & Actions -->
                    <div class="flex items-center justify-between sm:justify-end gap-3 sm:gap-4">
                        <!-- Connection Info -->
                        <div class="text-center hidden sm:block">
                            <div class="text-xs font-medium text-gray-500">Derni√®re connexion</div>
                            {% if compte.derniere_connexion %}
                                <div class="text-xs text-gray-900">{{ compte.derniere_connexion|date:"d/m/Y H:i" }}</div>
                            {% else %}
                                <div class="text-xs text-gray-400 italic">Jamais</div>
                            {% endif %}
                        </div>

                        <!-- Actions -->
                        <div class="flex items-center gap-1">
                            {% if compte.membre %}
                            <a href="{% url 'detail_membre' compte.membre.id %}" 
                               class="inline-flex items-center justify-center w-8 h-8 bg-gradient-to-r from-emerald-500 to-teal-600 hover:from-emerald-600 hover:to-teal-700 text-white rounded-lg shadow-md hover:shadow-lg transform hover:scale-105 transition-all duration-300" 
                               title="Voir profil RH">
                                <span class="text-sm">üë•</span>
                            </a>
                            {% endif %}
                            
                            <a href="{% url 'modifier_compte' compte.id %}" 
                               class="inline-flex items-center justify-center w-8 h-8 bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white rounded-lg shadow-md hover:shadow-lg transform hover:scale-105 transition-all duration-300" 
                               title="Modifier compte">
                                <span class="text-sm">‚úèÔ∏è</span>
                            </a>
                            
                            {% if compte != user %}
                            <button type="button"
                                    data-compte-id="{{ compte.id }}"
                                    data-compte-name="{% if compte.membre %}{{ compte.membre.get_nom_complet }}{% else %}{{ compte.get_full_name }}{% endif %}"
                                    data-compte-active="{{ compte.statut_actif|yesno:'true,false' }}"
                                    onclick="showToggleCompteStatusModal(this.dataset.compteId, this.dataset.compteName, this.dataset.compteActive === 'true')" 
                                    class="inline-flex items-center justify-center w-8 h-8 {% if compte.statut_actif %}bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700{% else %}bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700{% endif %} text-white rounded-lg shadow-md hover:shadow-lg transform hover:scale-105 transition-all duration-300" 
                                    title="{% if compte.statut_actif %}D√©sactiver{% else %}Activer{% endif %}">
                                <span class="text-sm">{% if compte.statut_actif %}‚ùå{% else %}‚úÖ{% endif %}</span>
                            </button>
                            
                            <button type="button"
                                    data-compte-id="{{ compte.id }}"
                                    data-compte-name="{% if compte.membre %}{{ compte.membre.get_nom_complet }}{% else %}{{ compte.get_full_name }}{% endif %}"
                                    data-compte-username="{{ compte.username }}"
                                    onclick="showResetComptePasswordModal(this.dataset.compteId, this.dataset.compteName, this.dataset.compteUsername)" 
                                    class="inline-flex items-center justify-center w-8 h-8 bg-gradient-to-r from-yellow-500 to-orange-600 hover:from-yellow-600 hover:to-orange-700 text-white rounded-lg shadow-md hover:shadow-lg transform hover:scale-105 transition-all duration-300" 
                                    title="R√©initialiser mot de passe">
                                <span class="text-sm">üîë</span>
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Mobile Additional Info -->
                <div class="sm:hidden mt-2 pt-2 border-t border-gray-100">
                    <div class="flex items-center justify-between text-xs">
                        <div class="flex items-center text-gray-500">
                            <span class="mr-1">üïí</span>
                            {% if compte.derniere_connexion %}
                                <span>{{ compte.derniere_connexion|date:"d/m/Y" }}</span>
                            {% else %}
                                <span class="italic">Jamais connect√©</span>
                            {% endif %}
                        </div>
                        {% if compte.membre and compte.membre.poste %}
                        <div class="flex items-center text-gray-500">
                            <span class="mr-1">üíº</span>
                            <span>{{ compte.membre.poste|truncatechars:15 }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Pagination similaire √† gestion_membres.html -->
        {% if page_obj.has_other_pages %}
        <div class="bg-white rounded-lg px-3 md:px-4 py-3 shadow-md border border-white/20">
            <!-- Pagination code similar to membres template -->
        </div>
        {% endif %}
        
        {% else %}
        <!-- Aucun compte trouv√© -->
        <div class="bg-white rounded-lg p-6 md:p-8 shadow-md border border-white/20 text-center">
            <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <span class="text-gray-400 text-2xl">üîê</span>
            </div>
            <h3 class="text-lg font-medium text-gray-900 mb-2">Aucun compte trouv√©</h3>
            <p class="text-gray-600 mb-4">
                {% if search or statut_filter or role_filter %}
                    Aucun compte ne correspond aux crit√®res de recherche.
                {% else %}
                    Les comptes syst√®me sont cr√©√©s depuis les profils membres.
                {% endif %}
            </p>
            <a href="{% url 'gestion_membres' %}" class="inline-flex items-center px-4 py-2 bg-gradient-to-r from-emerald-500 to-teal-600 hover:from-emerald-600 hover:to-teal-700 text-white rounded-lg font-medium shadow-md hover:shadow-lg transform hover:scale-105 transition-all duration-300">
                <span class="mr-2">üë•</span>Voir les profils RH
            </a>
        </div>
        {% endif %}
    </div>
</div>

<!-- Modals pour les actions sur les comptes -->
<!-- Modal Toggle Status -->
<div id="toggleCompteStatusModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <h3 class="text-lg font-medium text-gray-900" id="modalCompteTitle">Confirmer l'action</h3>
            <div class="mt-2 px-7 py-3">
                <p class="text-sm text-gray-500" id="modalCompteMessage">
                    √ätes-vous s√ªr de vouloir modifier le statut de ce compte ?
                </p>
            </div>
            <div class="items-center px-4 py-3">
                <button id="confirmToggleCompteStatus" class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md w-24 mr-2 hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-300">
                    Confirmer
                </button>
                <button onclick="closeToggleCompteStatusModal()" class="px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md w-24 hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-300">
                    Annuler
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Reset Password -->
<div id="resetComptePasswordModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <h3 class="text-lg font-medium text-gray-900">R√©initialiser le mot de passe</h3>
            <div class="mt-2 px-7 py-3">
                <p class="text-sm text-gray-500" id="resetPasswordMessage">
                    √ätes-vous s√ªr de vouloir r√©initialiser le mot de passe ?
                </p>
            </div>
            <div class="items-center px-4 py-3">
                <button id="confirmResetComptePassword" class="px-4 py-2 bg-yellow-500 text-white text-base font-medium rounded-md w-24 mr-2 hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-yellow-300">
                    Confirmer
                </button>
                <button onclick="closeResetComptePasswordModal()" class="px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md w-24 hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-300">
                    Annuler
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Success Reset Password -->
<div id="resetPasswordSuccessModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-lg bg-white">
        <div class="mt-3">
            <!-- Header -->
            <div class="flex items-center justify-center w-12 h-12 mx-auto bg-green-100 rounded-full mb-4">
                <span class="text-green-600 text-2xl">üîë</span>
            </div>
            
            <div class="text-center">
                <h3 class="text-lg font-semibold text-gray-900 mb-2">Mot de passe r√©initialis√©</h3>
                <p class="text-sm text-gray-600 mb-4">Le mot de passe a √©t√© r√©initialis√© avec succ√®s.</p>
            </div>
            
            <!-- Informations de connexion -->
            <div class="bg-gray-50 rounded-lg p-4 mb-4">
                <div class="space-y-3">
                    <div>
                        <label class="block text-xs font-semibold text-gray-700 mb-1">Nom d'utilisateur</label>
                        <div class="flex items-center justify-between bg-white border border-gray-200 rounded-lg px-3 py-2">
                            <span id="resetSuccessUsername" class="text-sm font-mono text-gray-900"></span>
                            <button onclick="copyToClipboard('resetSuccessUsername')" class="text-blue-600 hover:text-blue-800 text-xs">
                                üìã Copier
                            </button>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-xs font-semibold text-gray-700 mb-1">Nouveau mot de passe</label>
                        <div class="flex items-center justify-between bg-white border border-gray-200 rounded-lg px-3 py-2">
                            <span id="resetSuccessPassword" class="text-sm font-mono text-gray-900"></span>
                            <button onclick="copyToClipboard('resetSuccessPassword')" class="text-blue-600 hover:text-blue-800 text-xs">
                                üìã Copier
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Avertissement -->
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-4">
                <div class="flex items-start">
                    <span class="text-yellow-600 text-sm mr-2">‚ö†Ô∏è</span>
                    <div>
                        <p class="text-xs font-medium text-yellow-800">Important</p>
                        <p class="text-xs text-yellow-700">Veuillez noter ces informations et les communiquer √† l'utilisateur de mani√®re s√©curis√©e.</p>
                    </div>
                </div>
            </div>
            
            <!-- Actions -->
            <div class="flex space-x-3">
                <button onclick="closeResetPasswordSuccessModal()" class="flex-1 bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white px-4 py-2 rounded-lg font-medium shadow-md hover:shadow-lg transform hover:scale-105 transition-all duration-300">
                    Fermer
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let currentCompteId = null;

// Toggle Status Modal
function showToggleCompteStatusModal(compteId, compteName, isActive) {
    currentCompteId = compteId;
    const modal = document.getElementById('toggleCompteStatusModal');
    const title = document.getElementById('modalCompteTitle');
    const message = document.getElementById('modalCompteMessage');
    
    const action = isActive ? 'd√©sactiver' : 'activer';
    title.textContent = `${action.charAt(0).toUpperCase() + action.slice(1)} le compte`;
    message.textContent = `√ätes-vous s√ªr de vouloir ${action} le compte de ${compteName} ?`;
    
    modal.classList.remove('hidden');
}

function closeToggleCompteStatusModal() {
    document.getElementById('toggleCompteStatusModal').classList.add('hidden');
    currentCompteId = null;
}

document.getElementById('confirmToggleCompteStatus').addEventListener('click', function() {
    if (currentCompteId) {
        fetch(`/comptes/${currentCompteId}/toggle-status/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Erreur: ' + (data.error || 'Une erreur est survenue'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Une erreur est survenue');
        });
        
        closeToggleCompteStatusModal();
    }
});

// Reset Password Modal
function showResetComptePasswordModal(compteId, compteName, username) {
    currentCompteId = compteId;
    const modal = document.getElementById('resetComptePasswordModal');
    const message = document.getElementById('resetPasswordMessage');
    
    message.textContent = `R√©initialiser le mot de passe du compte ${username} (${compteName}) ?`;
    
    modal.classList.remove('hidden');
}

function closeResetComptePasswordModal() {
    document.getElementById('resetComptePasswordModal').classList.add('hidden');
    currentCompteId = null;
}

// Reset Password Success Modal
function showResetPasswordSuccessModal(username, password) {
    document.getElementById('resetSuccessUsername').textContent = username;
    document.getElementById('resetSuccessPassword').textContent = password;
    document.getElementById('resetPasswordSuccessModal').classList.remove('hidden');
}

function closeResetPasswordSuccessModal() {
    document.getElementById('resetPasswordSuccessModal').classList.add('hidden');
    // Recharger la page apr√®s fermeture de la modale de succ√®s
    location.reload();
}

// Fonction pour copier dans le presse-papiers
function copyToClipboard(elementId) {
    const element = document.getElementById(elementId);
    const text = element.textContent;
    
    if (navigator.clipboard && window.isSecureContext) {
        // M√©thode moderne
        navigator.clipboard.writeText(text).then(() => {
            showCopyFeedback(element);
        }).catch(err => {
            console.error('Erreur lors de la copie:', err);
            fallbackCopyTextToClipboard(text, element);
        });
    } else {
        // M√©thode de fallback
        fallbackCopyTextToClipboard(text, element);
    }
}

function fallbackCopyTextToClipboard(text, element) {
    const textArea = document.createElement("textarea");
    textArea.value = text;
    textArea.style.top = "0";
    textArea.style.left = "0";
    textArea.style.position = "fixed";
    
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        document.execCommand('copy');
        showCopyFeedback(element);
    } catch (err) {
        console.error('Erreur lors de la copie:', err);
    }
    
    document.body.removeChild(textArea);
}

function showCopyFeedback(element) {
    const button = element.parentElement.querySelector('button');
    const originalText = button.textContent;
    button.textContent = '‚úÖ Copi√©!';
    button.classList.add('text-green-600');
    
    setTimeout(() => {
        button.textContent = originalText;
        button.classList.remove('text-green-600');
    }, 2000);
}

document.getElementById('confirmResetComptePassword').addEventListener('click', function() {
    if (currentCompteId) {
        fetch(`/comptes/${currentCompteId}/reset-password/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Fermer la modale de confirmation
                closeResetComptePasswordModal();
                
                // Afficher la modale de succ√®s avec les informations
                showResetPasswordSuccessModal(data.username, data.nouveau_mot_de_passe);
            } else {
                alert('Erreur: ' + (data.error || 'Une erreur est survenue'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Une erreur est survenue');
        });
    }
});

// Fermer les modals en cliquant √† l'ext√©rieur
document.getElementById('toggleCompteStatusModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeToggleCompteStatusModal();
    }
});

document.getElementById('resetComptePasswordModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeResetComptePasswordModal();
    }
});

document.getElementById('resetPasswordSuccessModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeResetPasswordSuccessModal();
    }
});
</script>
{% endblock %}