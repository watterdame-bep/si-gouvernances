{% extends 'base.html' %}

{% block title %}Notifications{% endblock %}

{% block page_title %}Notifications{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <div class="w-full max-w-4xl mx-auto">
        <!-- Header ultra-compact -->
        <div class="bg-white border-b border-gray-200 px-2 py-2">
            <div class="flex items-center justify-between gap-2">
                <!-- Titre -->
                <div class="flex items-center gap-2">
                    <div class="w-7 h-7 bg-blue-600 rounded-lg flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-bell text-white text-xs"></i>
                    </div>
                    <h1 class="text-sm md:text-base font-bold text-gray-900">Notifications</h1>
                </div>
                
                <!-- Actions -->
                <div class="flex items-center gap-1">
                    <!-- Badge non lues -->
                    <span id="badgeNonLues" class="px-1.5 py-0.5 bg-red-100 text-red-800 rounded-full text-xs font-medium hidden">
                        <span id="countNonLues">0</span>
                    </span>
                    
                    <!-- Bouton marquer tout comme lu -->
                    <button onclick="markAllAsRead()" 
                            id="btnMarkAll" 
                            title="Tout marquer comme lu"
                            class="w-7 h-7 md:w-auto md:h-auto md:px-2 md:py-1.5 text-xs bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors hidden flex items-center justify-center">
                        <i class="fas fa-check-double"></i>
                        <span class="hidden md:inline ml-1">Marquer</span>
                    </button>
                    
                    <!-- Bouton retour -->
                    <a href="{% url 'dashboard' %}" 
                       title="Retour au tableau de bord"
                       class="w-7 h-7 md:w-auto md:h-auto md:px-2 md:py-1.5 text-xs bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors flex items-center justify-center">
                        <i class="fas fa-arrow-left"></i>
                        <span class="hidden md:inline ml-1">Retour</span>
                    </a>
                </div>
            </div>
        </div>

        <!-- Contenu des notifications -->
        <div class="bg-white shadow-sm">
            <div class="min-h-96">
                <div id="listUnread" class="space-y-0">
                    <div class="flex items-center justify-center py-8">
                        <i class="fas fa-spinner fa-spin text-xl text-gray-400 mr-2"></i>
                        <p class="text-gray-500 text-sm">Chargement...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentTab = 'unread';
let notifications = { unread: [], read: [] };
// Chargement simple
function loadData() {
    console.log('Chargement des données...');
    
    fetch('/api/notifications/detailed/')
    .then(response => {
        console.log('Réponse reçue:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('Données:', data);
        
        if (data.success) {
            notifications.unread = data.notifications_non_lues || [];
            notifications.read = data.notifications_lues || [];
            
            // Mettre à jour le badge
            const badgeNonLues = document.getElementById('badgeNonLues');
            const btnMarkAll = document.getElementById('btnMarkAll');
            const countNonLues = document.getElementById('countNonLues');
            
            if (countNonLues) countNonLues.textContent = notifications.unread.length;
            
            if (notifications.unread.length > 0) {
                if (badgeNonLues) badgeNonLues.classList.remove('hidden');
                if (btnMarkAll) btnMarkAll.classList.remove('hidden');
            } else {
                if (badgeNonLues) badgeNonLues.classList.add('hidden');
                if (btnMarkAll) btnMarkAll.classList.add('hidden');
            }
            
            // Afficher toutes les notifications
            showAllNotifications();
            
            console.log('✅ Données chargées avec succès');
        } else {
            console.error('Erreur API:', data.error);
            document.getElementById('listUnread').innerHTML = '<p class="text-red-500">Erreur: ' + (data.error || 'Erreur inconnue') + '</p>';
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        document.getElementById('listUnread').innerHTML = '<p class="text-red-500">Erreur de connexion: ' + error.message + '</p>';
    });
}

// Afficher toutes les notifications (lues et non lues mélangées)
function showAllNotifications() {
    const container = document.getElementById('listUnread');
    
    // Combiner toutes les notifications
    const allNotifications = [...notifications.unread, ...notifications.read];
    
    if (allNotifications.length === 0) {
        container.innerHTML = `
            <div class="text-center py-8">
                <div class="w-12 h-12 mx-auto mb-3 bg-gray-100 rounded-full flex items-center justify-center">
                    <i class="fas fa-bell-slash text-xl text-gray-400"></i>
                </div>
                <h3 class="text-sm font-semibold text-gray-900 mb-1">Aucune notification</h3>
                <p class="text-xs text-gray-500">Vous n'avez pas encore de notifications.</p>
            </div>
        `;
        return;
    }
    
    // Trier par date (plus récentes en premier)
    allNotifications.sort((a, b) => new Date(b.date_creation) - new Date(a.date_creation));
    
    // Séparer en "Aujourd'hui" et "Anciennes"
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    const todayNotifs = allNotifications.filter(n => {
        const notifDate = new Date(n.date_creation);
        notifDate.setHours(0, 0, 0, 0);
        return notifDate.getTime() === today.getTime();
    });
    
    const olderNotifs = allNotifications.filter(n => {
        const notifDate = new Date(n.date_creation);
        notifDate.setHours(0, 0, 0, 0);
        return notifDate.getTime() < today.getTime();
    });
    
    let html = '';
    
    // Section "Aujourd'hui"
    if (todayNotifs.length > 0) {
        html += `
            <div class="mb-2">
                <h3 class="text-xs font-semibold text-gray-700 px-2 py-1.5 bg-gray-50">Aujourd'hui</h3>
                <div class="divide-y divide-gray-100">
        `;
        
        todayNotifs.forEach(notif => {
            html += renderNotification(notif);
        });
        
        html += `
                </div>
            </div>
        `;
    }
    
    // Section "Anciennes"
    if (olderNotifs.length > 0) {
        html += `
            <div class="mb-2">
                <h3 class="text-xs font-semibold text-gray-700 px-2 py-1.5 bg-gray-50">Anciennes</h3>
                <div class="divide-y divide-gray-100">
        `;
        
        olderNotifs.forEach(notif => {
            html += renderNotification(notif);
        });
        
        html += `
                </div>
            </div>
        `;
    }
    
    container.innerHTML = html;
}

// Fonction pour rendre une notification individuelle
function renderNotification(notif) {
    const timeAgo = formatTimeAgo(notif.date_creation);
    const isUnread = !notif.lue;
    
    // Couleur de fond selon le statut
    const bgColor = isUnread ? 'bg-blue-50 hover:bg-blue-100' : 'bg-white hover:bg-gray-50';
    const borderColor = isUnread ? 'border-l-2 border-blue-500' : '';
    
    return `
        <a href="/notifications/${notif.id}/redirect/" 
           class="block ${bgColor} ${borderColor} px-2 py-2 transition-colors duration-150">
            <div class="flex items-start gap-2">
                <div class="flex-shrink-0 mt-0.5">
                    ${isUnread ? '<div class="w-1.5 h-1.5 bg-blue-600 rounded-full"></div>' : '<div class="w-1.5 h-1.5"></div>'}
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-xs text-gray-900 leading-snug">
                        ${notif.message}
                    </p>
                    <p class="text-xs text-gray-500 mt-0.5">
                        <i class="fas fa-clock text-xs"></i> ${timeAgo}
                    </p>
                </div>
            </div>
        </a>
    `;
}

// Afficher non lues (ancienne fonction - maintenant inutilisée)
function showUnread() {
    showAllNotifications();
}

// Afficher lues (ancienne fonction - maintenant inutilisée)
function showRead() {
    // Ne rien faire, tout est géré par showAllNotifications
}

// Changer d'onglet
function showTab(tab) {
    currentTab = tab;
    
    const btnUnread = document.getElementById('btnUnread');
    const btnRead = document.getElementById('btnRead');
    const tabUnread = document.getElementById('tabUnread');
    const tabRead = document.getElementById('tabRead');
    
    if (tab === 'unread') {
        btnUnread.className = 'py-4 px-1 border-b-2 border-blue-500 font-medium text-sm text-blue-600 whitespace-nowrap transition-all duration-200';
        btnRead.className = 'py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap transition-all duration-200';
        tabUnread.classList.remove('hidden');
        tabRead.classList.add('hidden');
    } else {
        btnRead.className = 'py-4 px-1 border-b-2 border-blue-500 font-medium text-sm text-blue-600 whitespace-nowrap transition-all duration-200';
        btnUnread.className = 'py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap transition-all duration-200';
        tabRead.classList.remove('hidden');
        tabUnread.classList.add('hidden');
    }
}

// Marquer comme lu
function markRead(id) {
    fetch(`/api/notifications/${id}/mark-read/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadData(); // Recharger
        } else {
            alert('Erreur: ' + (data.error || 'Erreur inconnue'));
        }
    })
    .catch(error => {
        alert('Erreur de connexion: ' + error.message);
    });
}

// Gérer le clic sur une notification
function handleNotificationClick(notifId, sourceType, tacheId, etapeId, moduleId, projetId) {
    console.log('=== CLICK NOTIFICATION ===');
    console.log('notifId:', notifId);
    console.log('sourceType:', sourceType);
    console.log('tacheId:', tacheId);
    console.log('etapeId:', etapeId);
    console.log('moduleId:', moduleId);
    console.log('projetId:', projetId);
    
    // Déterminer l'URL de redirection selon le type
    let redirectUrl = null;
    
    if (sourceType === 'tache' && tacheId && etapeId && projetId) {
        // Rediriger vers la page de gestion des tâches de l'étape
        redirectUrl = `/projets/${projetId}/etapes/${etapeId}/taches/`;
        console.log('Type: TACHE - URL:', redirectUrl);
    } else if (sourceType === 'etape' && etapeId && projetId) {
        // Rediriger vers la page de détail de l'étape
        redirectUrl = `/projets/${projetId}/etapes/${etapeId}/`;
        console.log('Type: ETAPE - URL:', redirectUrl);
    } else if (sourceType === 'module' && moduleId && projetId) {
        // Rediriger vers la page de gestion des tâches du module
        redirectUrl = `/projets/${projetId}/modules/${moduleId}/taches/`;
        console.log('Type: MODULE - URL:', redirectUrl);
    } else {
        // Par défaut, rediriger vers le dashboard
        redirectUrl = '/dashboard/';
        console.log('Type: FALLBACK - URL:', redirectUrl);
    }
    
    // Vérifier si la notification est déjà lue
    const isRead = notifications.read.some(n => n.id === notifId);
    console.log('isRead:', isRead);
    
    if (isRead) {
        // Si déjà lue, rediriger directement
        console.log('Redirection directe vers:', redirectUrl);
        window.location.href = redirectUrl;
    } else {
        // Si non lue, marquer comme lue puis rediriger
        console.log('Marquage comme lue puis redirection...');
        fetch(`/api/notifications/${notifId}/mark-read/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            console.log('Réponse API:', data);
            // Rediriger dans tous les cas
            console.log('Redirection vers:', redirectUrl);
            window.location.href = redirectUrl;
        })
        .catch(error => {
            console.error('Erreur:', error);
            // Rediriger quand même
            console.log('Redirection malgré erreur vers:', redirectUrl);
            window.location.href = redirectUrl;
        });
    }
}

// Initialisation au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    console.log('Page chargée, initialisation...');
    loadData();
});
</script>

<style>
/* Styles modernes pour les notifications */
.tab-content {
    min-height: 400px;
}

.notification-item {
    word-wrap: break-word;
    overflow-wrap: break-word;
}

/* Animations fluides */
.transition-colors {
    transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
}

/* Responsive design */
@media (max-width: 640px) {
    .notification-item p {
        word-break: break-word;
        hyphens: auto;
    }
    
    .notification-item .flex {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.75rem;
    }
    
    .notification-item .flex-1 {
        width: 100%;
    }
}

/* Hover effects */
.hover\:bg-red-100:hover {
    background-color: #fef2f2;
}

.hover\:bg-gray-100:hover {
    background-color: #f3f4f6;
}

/* Shadow effects */
.shadow-sm {
    box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
}
</style>
{% endblock %}

// Marquer toutes les notifications comme lues
function markAllAsRead() {
    if (confirm('Marquer toutes les notifications comme lues ?')) {
        fetch('/api/notifications/mark-all-read/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadData(); // Recharger
                showTab('read'); // Basculer vers l'onglet lues
            } else {
                alert('Erreur: ' + (data.error || 'Erreur inconnue'));
            }
        })
        .catch(error => {
            alert('Erreur de connexion: ' + error.message);
        });
    }
}

// Formater le temps écoulé
function formatTimeAgo(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diffInSeconds = Math.floor((now - date) / 1000);
    
    if (diffInSeconds < 60) {
        return 'À l\'instant';
    } else if (diffInSeconds < 3600) {
        const minutes = Math.floor(diffInSeconds / 60);
        return `Il y a ${minutes} min`;
    } else if (diffInSeconds < 86400) {
        const hours = Math.floor(diffInSeconds / 3600);
        return `Il y a ${hours}h`;
    } else {
        const days = Math.floor(diffInSeconds / 86400);
        return `Il y a ${days}j`;
    }
}