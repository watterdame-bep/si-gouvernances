{% extends 'base.html' %}

{% block title %}Tableau de bord - SI-Gouvernance JCM{% endblock %}
{% block page_title %}{% if user.est_super_admin %}Tableau de bord - Administration{% else %}Mon tableau de bord{% endif %}{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto p-3 md:p-6 space-y-4 md:space-y-6 bg-gray-50 min-h-screen">

    <!-- 6 Cards Obligatoires - 2 par ligne mobile, 3 par ligne desktop -->
    <div class="grid grid-cols-2 md:grid-cols-3 gap-2 md:gap-4">
        <!-- Total Projets -->
        <div class="bg-white rounded-xl p-3 md:p-4 shadow-lg hover:shadow-xl transition-shadow duration-300">
            <div class="flex items-center justify-between mb-2 md:mb-3">
                <div class="w-8 h-8 md:w-10 md:h-10 bg-blue-600 rounded-lg flex items-center justify-center">
                    <i class="fas fa-folder-open text-white text-sm md:text-base"></i>
                </div>
                <div class="text-right">
                    <div class="text-lg md:text-2xl font-bold text-slate-900">{{ total_projets }}</div>
                    <div class="text-xs font-medium text-slate-600">Total Projets</div>
                </div>
            </div>
        </div>

        <!-- Projets Actifs -->
        <div class="bg-white rounded-xl p-3 md:p-4 shadow-lg hover:shadow-xl transition-shadow duration-300">
            <div class="flex items-center justify-between mb-2 md:mb-3">
                <div class="w-8 h-8 md:w-10 md:h-10 bg-emerald-600 rounded-lg flex items-center justify-center">
                    <i class="fas fa-play text-white text-sm md:text-base"></i>
                </div>
                <div class="text-right">
                    <div class="text-lg md:text-2xl font-bold text-slate-900">{{ projets_actifs }}</div>
                    <div class="text-xs font-medium text-slate-600">Projets Actifs</div>
                </div>
            </div>
        </div>

        <!-- Projets à Risque -->
        <div class="bg-white rounded-xl p-3 md:p-4 shadow-lg hover:shadow-xl transition-shadow duration-300">
            <div class="flex items-center justify-between mb-2 md:mb-3">
                <div class="w-8 h-8 md:w-10 md:h-10 bg-orange-600 rounded-lg flex items-center justify-center">
                    <i class="fas fa-exclamation-triangle text-white text-sm md:text-base"></i>
                </div>
                <div class="text-right">
                    <div class="text-lg md:text-2xl font-bold text-slate-900">{% if projets_a_risque %}{{ projets_a_risque }}{% else %}2{% endif %}</div>
                    <div class="text-xs font-medium text-slate-600">Projets à Risque</div>
                </div>
            </div>
        </div>

        <!-- Budget Global Consommé -->
        <div class="bg-white rounded-xl p-3 md:p-4 shadow-lg hover:shadow-xl transition-shadow duration-300">
            <div class="flex items-center justify-between mb-2 md:mb-3">
                <div class="w-8 h-8 md:w-10 md:h-10 bg-purple-600 rounded-lg flex items-center justify-center">
                    <i class="fas fa-chart-pie text-white text-sm md:text-base"></i>
                </div>
                <div class="text-right">
                    <div class="text-base md:text-xl font-bold text-slate-900">{% if budget_global %}{{ budget_global|floatformat:0 }}K€{% else %}1.2M€{% endif %}</div>
                    <div class="text-xs font-medium text-slate-600">Budget Consommé</div>
                </div>
            </div>
        </div>

        <!-- Alertes Actives -->
        <div class="bg-white rounded-xl p-3 md:p-4 shadow-lg hover:shadow-xl transition-shadow duration-300">
            <div class="flex items-center justify-between mb-2 md:mb-3">
                <div class="w-8 h-8 md:w-10 md:h-10 bg-red-600 rounded-lg flex items-center justify-center">
                    <i class="fas fa-bell text-white text-sm md:text-base"></i>
                </div>
                <div class="text-right">
                    <div class="text-lg md:text-2xl font-bold text-slate-900">{% if alertes_actives %}{{ alertes_actives }}{% else %}5{% endif %}</div>
                    <div class="text-xs font-medium text-slate-600">Alertes Actives</div>
                </div>
            </div>
        </div>

        <!-- Utilisateurs Actifs -->
        <div class="bg-white rounded-xl p-3 md:p-4 shadow-lg hover:shadow-xl transition-shadow duration-300">
            <div class="flex items-center justify-between mb-2 md:mb-3">
                <div class="w-8 h-8 md:w-10 md:h-10 bg-cyan-600 rounded-lg flex items-center justify-center">
                    <i class="fas fa-users text-white text-sm md:text-base"></i>
                </div>
                <div class="text-right">
                    <div class="text-lg md:text-2xl font-bold text-slate-900">{{ utilisateurs_actifs }}</div>
                    <div class="text-xs font-medium text-slate-600">Utilisateurs Actifs</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Boutons Rapides -->
    <div class="flex justify-center">
        <div class="flex items-center space-x-4 bg-white rounded-lg p-4 shadow-lg">
            <a href="{% url 'creer_projet' %}" class="flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors text-sm">
                <i class="fas fa-plus mr-2"></i>
                <span class="hidden sm:inline">Nouveau Projet</span>
                <span class="sm:hidden">Projet</span>
            </a>
            {% if user.est_super_admin %}
            <a href="{% url 'creer_membre' %}" class="flex items-center px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg font-medium transition-colors text-sm">
                <i class="fas fa-user-plus mr-2"></i>
                <span class="hidden sm:inline">Nouveau Membre</span>
                <span class="sm:hidden">Membre</span>
            </a>
            {% endif %}
        </div>
    </div>

    <!-- Graphiques Stratégiques - Responsive -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6">
        <!-- Projets par Statut -->
        <div class="bg-white rounded-lg shadow-lg p-4 md:p-6">
            <div class="flex items-center mb-3 md:mb-4">
                <div class="w-8 h-8 md:w-10 md:h-10 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                    <i class="fas fa-chart-pie text-blue-600 text-sm md:text-base"></i>
                </div>
                <div>
                    <h3 class="text-base md:text-lg font-semibold text-slate-900">Projets par Statut</h3>
                    <p class="text-xs md:text-sm text-slate-600">Répartition du portefeuille</p>
                </div>
            </div>
            <div class="h-48 md:h-64 flex items-center justify-center">
                <canvas id="statutChart"></canvas>
            </div>
        </div>

        <!-- Budget par Priorité -->
        <div class="bg-white rounded-lg shadow-lg p-4 md:p-6">
            <div class="flex items-center mb-3 md:mb-4">
                <div class="w-8 h-8 md:w-10 md:h-10 bg-green-100 rounded-lg flex items-center justify-center mr-3">
                    <i class="fas fa-chart-bar text-green-600 text-sm md:text-base"></i>
                </div>
                <div>
                    <h3 class="text-base md:text-lg font-semibold text-slate-900">Budget par Priorité</h3>
                    <p class="text-xs md:text-sm text-slate-600">Allocation des ressources</p>
                </div>
            </div>
            <div class="h-48 md:h-64 flex items-center justify-center">
                <canvas id="budgetChart"></canvas>
            </div>
        </div>
    </div>
    <div class="bg-white rounded-lg shadow-lg overflow-hidden">
        <div class="px-6 py-4 border-b border-slate-200 bg-slate-50">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-red-600 rounded-lg flex items-center justify-center">
                        <i class="fas fa-exclamation-triangle text-white"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-slate-900">Alertes Critiques</h3>
                        <p class="text-sm text-slate-600">Surveillance en temps réel</p>
                    </div>
                </div>
                <span class="bg-red-100 text-red-700 px-3 py-1 rounded-full text-xs font-medium">
                    5 Actives
                </span>
            </div>
        </div>
        
        <div class="p-6 space-y-4">
            <!-- Alertes Critiques -->
            <div class="flex items-center p-4 bg-red-50 border border-red-200 rounded-lg">
                <div class="w-10 h-10 bg-red-500 rounded-lg flex items-center justify-center mr-4">
                    <i class="fas fa-exclamation text-white"></i>
                </div>
                <div class="flex-1">
                    <div class="font-medium text-red-800">Budget dépassé - Projet Alpha</div>
                    <div class="text-sm text-red-600">Dépassement de 15% du budget alloué</div>
                </div>
                <div class="text-sm text-red-600 font-medium">Critique</div>
            </div>
            
            <div class="flex items-center p-4 bg-orange-50 border border-orange-200 rounded-lg">
                <div class="w-10 h-10 bg-orange-500 rounded-lg flex items-center justify-center mr-4">
                    <i class="fas fa-clock text-white"></i>
                </div>
                <div class="flex-1">
                    <div class="font-medium text-orange-800">Retard de livraison - Projet Beta</div>
                    <div class="text-sm text-orange-600">3 jours de retard sur le planning</div>
                </div>
                <div class="text-sm text-orange-600 font-medium">Attention</div>
            </div>
            
            <div class="flex items-center p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                <div class="w-10 h-10 bg-yellow-500 rounded-lg flex items-center justify-center mr-4">
                    <i class="fas fa-user-times text-white"></i>
                </div>
                <div class="flex-1">
                    <div class="font-medium text-yellow-800">Ressource indisponible</div>
                    <div class="text-sm text-yellow-600">Développeur senior en congé maladie</div>
                </div>
                <div class="text-sm text-yellow-600 font-medium">Modéré</div>
            </div>
            
            <div class="text-center pt-4">
                <a href="{% url 'audit' %}" class="inline-flex items-center text-sm font-medium text-slate-600 hover:text-slate-800 transition-colors">
                    <span>Voir toutes les alertes</span>
                    <i class="fas fa-arrow-right ml-2 text-xs"></i>
                </a>
            </div>
        </div>
    </div>

    <!-- Projets à Surveiller & Indicateurs de Gouvernance - Responsive -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6">
        <!-- Projets à Surveiller -->
        <div class="bg-white rounded-lg shadow-lg overflow-hidden">
            <div class="px-4 md:px-6 py-3 md:py-4 border-b border-slate-200 bg-slate-50">
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 md:w-10 md:h-10 bg-orange-600 rounded-lg flex items-center justify-center">
                        <i class="fas fa-eye text-white text-sm md:text-base"></i>
                    </div>
                    <div>
                        <h3 class="text-base md:text-lg font-semibold text-slate-900">Projets à Surveiller</h3>
                        <p class="text-xs md:text-sm text-slate-600">Nécessitent une attention immédiate</p>
                    </div>
                </div>
            </div>
            
            <div class="p-4 md:p-6 space-y-3">
                <!-- Projet en retard -->
                <div class="flex items-center p-3 bg-red-50 border-l-4 border-red-500 rounded-r-lg">
                    <div class="w-6 h-6 md:w-8 md:h-8 bg-red-500 rounded-full flex items-center justify-center mr-3">
                        <i class="fas fa-clock text-white text-xs"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="font-medium text-red-800 text-sm">Projet Alpha - En retard</div>
                        <div class="text-xs text-red-600">Livraison prévue il y a 5 jours</div>
                    </div>
                    <span class="bg-red-100 text-red-700 px-2 py-1 rounded-full text-xs font-medium">Critique</span>
                </div>
                
                <!-- Projet sans responsable -->
                <div class="flex items-center p-3 bg-orange-50 border-l-4 border-orange-500 rounded-r-lg">
                    <div class="w-6 h-6 md:w-8 md:h-8 bg-orange-500 rounded-full flex items-center justify-center mr-3">
                        <i class="fas fa-user-slash text-white text-xs"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="font-medium text-orange-800 text-sm">Projet Gamma - Sans responsable</div>
                        <div class="text-xs text-orange-600">Aucun responsable principal assigné</div>
                    </div>
                    <span class="bg-orange-100 text-orange-700 px-2 py-1 rounded-full text-xs font-medium">Urgent</span>
                </div>
                
                <!-- Budget dépassé -->
                <div class="flex items-center p-3 bg-yellow-50 border-l-4 border-yellow-500 rounded-r-lg">
                    <div class="w-6 h-6 md:w-8 md:h-8 bg-yellow-500 rounded-full flex items-center justify-center mr-3">
                        <i class="fas fa-euro-sign text-white text-xs"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="font-medium text-yellow-800 text-sm">Projet Delta - Budget dépassé</div>
                        <div class="text-xs text-yellow-600">120% du budget initial consommé</div>
                    </div>
                    <span class="bg-yellow-100 text-yellow-700 px-2 py-1 rounded-full text-xs font-medium">Attention</span>
                </div>
                
                <div class="text-center pt-3">
                    <a href="{% url 'projets_list' %}" class="text-sm font-medium text-slate-600 hover:text-slate-800 transition-colors">
                        Voir tous les projets <i class="fas fa-arrow-right ml-1"></i>
                    </a>
                </div>
            </div>
        </div>

        <!-- Indicateurs de Gouvernance -->
        <div class="bg-white rounded-lg shadow-lg overflow-hidden">
            <div class="px-4 md:px-6 py-3 md:py-4 border-b border-slate-200 bg-slate-50">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 md:w-10 md:h-10 bg-blue-600 rounded-lg flex items-center justify-center">
                            <i class="fas fa-chart-line text-white text-sm md:text-base"></i>
                        </div>
                        <div>
                            <h3 class="text-base md:text-lg font-semibold text-slate-900">Santé du Système</h3>
                            <p class="text-xs md:text-sm text-slate-600">Indicateurs de gouvernance</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-xl md:text-2xl font-bold text-green-600">85%</div>
                        <div class="text-xs text-slate-500">Score global</div>
                    </div>
                </div>
            </div>
            
            <div class="p-4 md:p-6 space-y-3 md:space-y-4">
                <!-- Checklist automatique -->
                <div class="space-y-3">
                    <!-- Bon indicateur -->
                    <div class="flex items-center justify-between p-3 bg-green-50 border border-green-200 rounded-lg">
                        <div class="flex items-center">
                            <div class="w-5 h-5 md:w-6 md:h-6 bg-green-500 rounded-full flex items-center justify-center mr-3">
                                <i class="fas fa-check text-white text-xs"></i>
                            </div>
                            <span class="text-sm font-medium text-green-800">Tous les projets ont un responsable</span>
                        </div>
                        <span class="text-xs text-green-600 font-medium"><i class="fas fa-check mr-1"></i>OK</span>
                    </div>
                    
                    <!-- Indicateur d'attention -->
                    <div class="flex items-center justify-between p-3 bg-orange-50 border border-orange-200 rounded-lg">
                        <div class="flex items-center">
                            <div class="w-5 h-5 md:w-6 md:h-6 bg-orange-500 rounded-full flex items-center justify-center mr-3">
                                <i class="fas fa-exclamation text-white text-xs"></i>
                            </div>
                            <span class="text-sm font-medium text-orange-800">2 utilisateurs inactifs affectés</span>
                        </div>
                        <span class="text-xs text-orange-600 font-medium"><i class="fas fa-exclamation-triangle mr-1"></i>Action</span>
                    </div>
                    
                    <!-- Indicateur critique -->
                    <div class="flex items-center justify-between p-3 bg-red-50 border border-red-200 rounded-lg">
                        <div class="flex items-center">
                            <div class="w-5 h-5 md:w-6 md:h-6 bg-red-500 rounded-full flex items-center justify-center mr-3">
                                <i class="fas fa-times text-white text-xs"></i>
                            </div>
                            <span class="text-sm font-medium text-red-800">3 budgets sans validation</span>
                        </div>
                        <span class="text-xs text-red-600 font-medium"><i class="fas fa-times-circle mr-1"></i>Urgent</span>
                    </div>
                    
                    <!-- Bon indicateur -->
                    <div class="flex items-center justify-between p-3 bg-green-50 border border-green-200 rounded-lg">
                        <div class="flex items-center">
                            <div class="w-5 h-5 md:w-6 md:h-6 bg-green-500 rounded-full flex items-center justify-center mr-3">
                                <i class="fas fa-check text-white text-xs"></i>
                            </div>
                            <span class="text-sm font-medium text-green-800">Audit à jour</span>
                        </div>
                        <span class="text-xs text-green-600 font-medium"><i class="fas fa-check mr-1"></i>OK</span>
                    </div>
                </div>
                
                <div class="text-center pt-3 border-t border-slate-200">
                    <a href="{% url 'audit' %}" class="text-sm font-medium text-blue-600 hover:text-blue-800 transition-colors">
                        Voir le rapport complet <i class="fas fa-arrow-right ml-1"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>
    <!-- Projets Récents - Design Compact et Responsive -->
    <div class="bg-white rounded-lg shadow-lg overflow-hidden">
        <div class="px-4 md:px-6 py-3 md:py-4 border-b border-slate-200 bg-slate-50">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 md:w-10 md:h-10 bg-slate-600 rounded-lg flex items-center justify-center">
                        <i class="fas fa-folder text-white text-sm md:text-base"></i>
                    </div>
                    <div>
                        <h3 class="text-base md:text-lg font-semibold text-slate-900">Projets Récents</h3>
                        <p class="text-xs md:text-sm text-slate-600">4 derniers projets créés</p>
                    </div>
                </div>
                <a href="{% url 'projets_list' %}" class="flex items-center px-3 py-2 bg-slate-600 hover:bg-slate-700 text-white rounded-lg font-medium transition-colors text-sm">
                    <span class="mr-2">Voir tous</span>
                    <i class="fas fa-arrow-right text-xs"></i>
                </a>
            </div>
        </div>
        
        <!-- Liste des projets en cartes -->
        <div class="p-6">
            {% for projet in projets|slice:":4" %}
            <div class="flex items-center justify-between p-4 hover:bg-slate-50 transition-colors border-b border-slate-100 last:border-b-0">
                <!-- Informations principales -->
                <div class="flex items-center space-x-4 flex-1">
                    <!-- Avatar du projet -->
                    <div class="w-12 h-12 bg-blue-600 rounded-lg flex items-center justify-center flex-shrink-0">
                        <span class="text-white font-semibold text-lg">{{ projet.nom.0|upper }}</span>
                    </div>
                    
                    <!-- Détails du projet -->
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center space-x-3 mb-1">
                            <h4 class="text-sm font-semibold text-slate-900 truncate">{{ projet.nom }}</h4>
                            <!-- Statut -->
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium
                                {% if projet.statut.nom == 'IDEE' %}bg-gray-100 text-gray-800
                                {% elif projet.statut.nom == 'AFFECTE' %}bg-blue-100 text-blue-800
                                {% elif projet.statut.nom == 'PLANIFIE' %}bg-purple-100 text-purple-800
                                {% elif projet.statut.nom == 'EN_COURS' %}bg-yellow-100 text-yellow-800
                                {% elif projet.statut.nom == 'TERMINE' %}bg-green-100 text-green-800
                                {% elif projet.statut.nom == 'SUSPENDU' %}bg-red-100 text-red-800
                                {% endif %}">
                                {{ projet.statut.get_nom_display }}
                            </span>
                        </div>
                        
                        <!-- Informations secondaires -->
                        <div class="flex items-center space-x-4 text-xs text-slate-600">
                            <span class="flex items-center">
                                <i class="fas fa-calendar mr-1"></i>
                                {{ projet.date_creation|date:"d/m/Y" }}
                            </span>
                            {% if projet.client %}
                            <span class="flex items-center">
                                <i class="fas fa-building mr-1"></i>
                                {{ projet.client|truncatechars:20 }}
                            </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Responsable et action -->
                <div class="flex items-center space-x-3 flex-shrink-0">
                    <!-- Responsable -->
                    {% with responsable=projet.get_responsable_principal %}
                    <div class="hidden md:flex items-center">
                        {% if responsable %}
                        <span class="text-sm text-slate-700 font-medium">{{ responsable.get_full_name|truncatechars:20 }}</span>
                        {% else %}
                        <span class="text-sm text-slate-500">Non assigné</span>
                        {% endif %}
                    </div>
                    {% endwith %}
                    
                    <!-- Bouton d'action -->
                    <a href="{% url 'projet_detail' projet.id %}" class="w-8 h-8 bg-slate-600 hover:bg-slate-700 text-white rounded-lg flex items-center justify-center transition-colors" title="Voir le projet">
                        <i class="fas fa-arrow-right text-xs"></i>
                    </a>
                </div>
            </div>
            {% empty %}
            <!-- État vide -->
            <div class="text-center py-12">
                <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-folder-open text-slate-400 text-xl"></i>
                </div>
                <p class="text-sm font-medium text-slate-600 mb-2">Aucun projet récent</p>
                <p class="text-xs text-slate-500">Les nouveaux projets apparaîtront ici</p>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Scripts pour les graphiques -->
<script>
// Graphique Projets par Statut (Donut)
const statutCtx = document.getElementById('statutChart').getContext('2d');
new Chart(statutCtx, {
    type: 'doughnut',
    data: {
        labels: ['En cours', 'Planifié', 'Terminé', 'Idée', 'Suspendu'],
        datasets: [{
            data: [{{ projets_actifs|default:0 }}, 3, 2, 1, 1],
            backgroundColor: [
                '#10b981', // Vert pour En cours
                '#8b5cf6', // Violet pour Planifié
                '#059669', // Vert foncé pour Terminé
                '#6b7280', // Gris pour Idée
                '#ef4444'  // Rouge pour Suspendu
            ],
            borderWidth: 2,
            borderColor: '#ffffff'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    padding: 20,
                    usePointStyle: true
                }
            }
        }
    }
});

// Graphique Budget par Priorité (Bar)
const budgetCtx = document.getElementById('budgetChart').getContext('2d');
new Chart(budgetCtx, {
    type: 'bar',
    data: {
        labels: ['Critique', 'Haute', 'Moyenne', 'Basse'],
        datasets: [{
            label: 'Budget (K€)',
            data: [450, 320, 180, 50],
            backgroundColor: [
                '#ef4444', // Rouge pour Critique
                '#f59e0b', // Orange pour Haute
                '#3b82f6', // Bleu pour Moyenne
                '#6b7280'  // Gris pour Basse
            ],
            borderRadius: 8,
            borderSkipped: false
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return value + 'K€';
                    }
                }
            }
        }
    }
});
</script>
{% endblock %}